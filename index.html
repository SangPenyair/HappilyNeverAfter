<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>The Poet & The Princess</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Urbanist:wght@300;400;600;700;800&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

    <style>
        /* --- VARIABLES --- */
        :root {
            --primary-gold: #FFD700;
            --soft-gold: #FFE5B4;
            --deep-space: #020617;
            
            /* Chat Bubbles */
            --poet-bubble: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            
            /* Princess: Midnight Winter Blue (Deep Navy -> Cold Azure) */
            --princess-bubble: linear-gradient(135deg, rgba(23, 37, 84, 0.9), rgba(30, 58, 138, 0.85));
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%; height: 100dvh; width: 100%;
            overflow: hidden; font-family: 'Urbanist', sans-serif; color: white;
            background: #020617; /* Base Black */
            transition: background 4s ease-in-out; /* Smooth transition for Magical Ending */
        }

        /* --- TEXTURES --- */
        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 900; opacity: 0.4; mix-blend-mode: overlay;
        }
        
        .vignette-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.8) 100%);
            pointer-events: none; z-index: 899;
        }

        /* Ambient Orbs */
        .ambient-orb {
            position: fixed; border-radius: 50%; filter: blur(80px); z-index: -1; opacity: 0.4;
            animation: orbFloat 20s infinite alternate ease-in-out;
        }
        .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #1e3a8a; animation-delay: 0s; }
        .orb-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #581c87; animation-delay: -5s; }
        .orb-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #0f766e; animation-delay: -10s; opacity: 0.2; }
        @keyframes orbFloat { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 50px) scale(1.1); } }

        /* --- BACKGROUND LAYERS --- */
        .bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; transition: opacity 3s ease;
        }
        
        #bg-blue { 
            z-index: -2; 
            background: linear-gradient(180deg, rgba(5,16,36,1) 0%, rgba(2,6,23,1) 100%);
        }
        
        /* New Year Galaxy Purple */
        #bg-purple {
            z-index: -1;
            background: radial-gradient(circle at center, #4c1d95 0%, #2e1065 40%, #020617 90%);
            opacity: 0; 
        }
        
        /* Magical Golden Sunset (Hidden Ending) */
        #bg-sunset {
            z-index: 0; /* Above Purple */
            background: linear-gradient(180deg, #4c1d95 0%, #db2777 40%, #f59e0b 80%, #78350f 100%);
            opacity: 0;
        }

        body.royal-mode #bg-purple { 
            opacity: 1 !important; 
            animation: galaxyPulse 8s infinite alternate ease-in-out;
        }
        body.magical-mode #bg-sunset { opacity: 1 !important; }
        body.magical-mode #bg-purple { opacity: 0 !important; }
        
        @keyframes galaxyPulse {
            0% { filter: brightness(1) hue-rotate(0deg); transform: scale(1); }
            100% { filter: brightness(1.2) hue-rotate(10deg); transform: scale(1.02); }
        }

        /* CANVAS LAYERS */
        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #global-canvas { z-index: 1; opacity: 1; } /* Stars */
        #snow-canvas { z-index: 5; opacity: 1; pointer-events: none; }
        #lantern-canvas { z-index: 6; opacity: 0; pointer-events: none; transition: opacity 2s;} /* Lampion */
        
        #firework-canvas { 
            z-index: 10; 
            opacity: 0; 
            transition: opacity 1s; 
            filter: brightness(1.3) contrast(1.2);
        }

        /* FROSTED GLASS OVERLAY */
        #frosted-glass-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 15; 
            backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px);
            background: rgba(255, 255, 255, 0.0);
            pointer-events: none;
            transition: all 3s ease;
        }
        body.royal-mode #frosted-glass-layer {
            backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
            background: rgba(255, 255, 255, 0.01);
        }
        body.magical-mode #frosted-glass-layer {
            backdrop-filter: blur(0px); background: transparent; /* Clear view for lanterns */
        }

        #firefly-canvas { z-index: 16; opacity: 0; transition: opacity 1s; }
        #confetti-canvas { z-index: 9999; }
        
        /* UI FRAME */
        #mobile-frame {
            position: relative; width: 100%; height: 100%; max-width: 480px; margin: 0 auto;
            display: flex; flex-direction: column; z-index: 50;
            transition: opacity 1.5s cubic-bezier(0.16, 1, 0.3, 1);
            background: rgba(0,0,0,0.2);
        }

        /* HEADER */
        .header {
            flex: 0 0 auto; padding: 20px 24px; padding-top: max(20px, env(safe-area-inset-top));
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.01);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 50;
        }
        .header-title {
            font-family: 'Cinzel', serif; font-weight: 700; color: var(--primary-gold);
            letter-spacing: 2px; font-size: 1.1rem; text-transform: capitalize;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
            position: relative;
        }
        .header-title::after {
            content: ''; position: absolute; bottom: -5px; left: 0; width: 30%; height: 1px;
            background: var(--primary-gold); box-shadow: 0 0 10px var(--primary-gold);
        }

        .heart-counter {
            background: rgba(0,0,0,0.4); padding: 8px 16px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.08); font-size: 0.9rem; font-weight: 700;
            display: flex; align-items: center; gap: 8px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            opacity: 0; transform: translateY(-20px) scale(0.9); 
            transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
            filter: blur(5px);
        }
        .heart-counter.reveal { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }

        /* CHAT */
        #chat-content {
            flex: 1; overflow-y: auto; padding: 20px 16px; padding-bottom: 40px;
            display: flex; flex-direction: column; gap: 24px;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
            mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
        }
        #chat-content::-webkit-scrollbar { display: none; }

        .dialog-container {
            display: flex; flex-direction: column; max-width: 88%;
            opacity: 0; 
            animation: cinematicReveal 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        .princess-container { align-self: flex-end; align-items: flex-end; }

        @keyframes cinematicReveal {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); filter: blur(10px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }

        .dialog-label {
            font-family: 'Cinzel', serif; font-size: 0.65rem; margin-bottom: 6px; 
            font-weight: 600; opacity: 0.7; letter-spacing: 1px; margin-left: 12px; text-transform: uppercase;
            color: var(--soft-gold);
        }
        
        .princess-container .dialog-label { margin-right: 12px; margin-left: 0; color: #bae6fd; text-shadow: 0 0 8px rgba(56, 189, 248, 0.6); }

        .dialog-box {
            padding: 16px 20px; border-radius: 24px; font-size: 1.05rem; line-height: 1.6;
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative; overflow: hidden;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        .poet-container .dialog-box { 
            background: var(--poet-bubble); color: #e2e8f0; border-bottom-left-radius: 4px; 
            box-shadow: 5px 5px 20px rgba(0,0,0,0.2);
        }
        
        /* Princess Bubble: Midnight Winter Blue */
        .princess-container .dialog-box { 
            background: var(--princess-bubble); 
            color: #fff; border-bottom-right-radius: 4px; 
            box-shadow: -5px 5px 25px rgba(59, 130, 246, 0.3); /* Cold Blue Glow */
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .narrative {
            align-self: center; text-align: center;
            font-family: 'Urbanist', sans-serif; font-weight: 300; font-size: 0.9rem; letter-spacing: 1px;
            color: rgba(255,255,255,0.8); margin: 20px 0; max-width: 85%;
            padding: 12px 30px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            border-top: 1px solid rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            opacity: 0; animation: cinematicReveal 1.5s ease forwards;
            font-style: italic;
        }

        /* INPUT AREA */
        #input-area {
            flex: 0 0 auto; padding: 25px;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px);
            border-top: 1px solid rgba(255,255,255,0.08);
            padding-bottom: max(25px, env(safe-area-inset-bottom));
            display: flex; flex-direction: column; gap: 15px;
            transition: opacity 0.5s ease;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        }

        /* --- PILIHAN: SAPPHIRE ICE GLASS --- */
        .choice-btn {
            background: rgba(30, 58, 138, 0.35); /* Sapphire Tint */
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(56, 189, 248, 0.3); /* Cyan Border */
            
            padding: 18px; border-radius: 20px; color: #e0f2fe;
            font-family: 'Urbanist'; font-weight: 600; text-align: center; letter-spacing: 0.5px;
            cursor: pointer; position: relative; overflow: hidden;
            opacity: 0; animation: slideUpBlur 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            box-shadow: 0 4px 20px rgba(23, 37, 84, 0.4);
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.4);
        }
        .choice-btn:hover {
            transform: translateY(-3px) scale(1.02);
            border-color: rgba(125, 211, 252, 0.6);
            background: rgba(30, 64, 175, 0.5);
            box-shadow: 0 10px 30px rgba(30, 58, 138, 0.5), 0 0 20px rgba(56, 189, 248, 0.2);
            color: #fff;
        }
        @keyframes slideUpBlur { 
            0% { opacity: 0; transform: translateY(30px); filter: blur(10px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); } 
        }

        .input-wrap { display: flex; gap: 12px; width: 100%; animation: slideUpBlur 0.6s forwards; }
        .text-input {
            flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
            padding: 16px 24px; color: white; border-radius: 30px; outline: none; font-size: 1rem;
            transition: 0.4s; font-family: 'Urbanist'; backdrop-filter: blur(10px);
        }
        .text-input:focus { 
            background: rgba(255,255,255,0.1); border-color: var(--primary-gold); 
            box-shadow: 0 0 25px rgba(255,215,0,0.15); 
        }
        .send-btn {
            width: 54px; height: 54px; border-radius: 50%; border:none;
            background: conic-gradient(from 180deg, var(--primary-gold), #FDB931, var(--primary-gold));
            color: black; font-weight: bold; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 0 30px rgba(255,215,0,0.3);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .send-btn:active { transform: scale(0.85) rotate(15deg); }

        /* NOTIFICATION PILL */
        #notification {
            position: fixed; top: 20px; left: 50%; transform: translate(-50%, -200%);
            background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(20px) saturate(200%);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 14px 30px; border-radius: 50px;
            display: flex; align-items: center; justify-content: center; gap: 14px;
            color: white; font-family: 'Urbanist'; font-weight: 700; font-size: 0.95rem;
            z-index: 10001; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.8s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7); width: max-content; max-width: 90%;
            filter: blur(10px); opacity: 0;
        }
        .show-notif { transform: translate(-50%, 0) !important; filter: blur(0) !important; opacity: 1 !important; }
        .notif-icon { font-size: 1.4rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }

        /* IDENTITY */
        #identity-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.6); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.8s ease;
        }
        .id-box {
            text-align:center; width:85%; max-width:340px;
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            padding: 45px 30px; border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 40px 80px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.05);
            transform: scale(0.9) blur(10px); transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .id-active .id-box { transform: scale(1) blur(0); }

        .id-input {
            width: 100%; padding: 20px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.15);
            background: rgba(0,0,0,0.3); color: white; text-align: center; font-size: 1.15rem; outline: none; margin-bottom: 25px; font-family: 'Urbanist'; letter-spacing: 1px;
            transition: 0.4s;
        }
        .id-input:focus { border-color: var(--primary-gold); background: rgba(0,0,0,0.5); box-shadow: 0 0 30px rgba(255,215,0,0.1); }
        .shake-hard { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        /* START OVERLAY */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020617; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 2s ease; }
        
        #click-catcher {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: rgba(255,255,255,0.5); font-family: 'Urbanist'; letter-spacing: 6px; font-size: 0.85rem;
            cursor: pointer; animation: breathe 4s infinite ease-in-out; z-index: 2; transition: opacity 1s, filter 1s;
        }
        @keyframes breathe { 0%, 100% { opacity: 0.3; transform: scale(0.98); } 50% { opacity: 0.8; transform: scale(1.02); } }

        .title-container { 
            opacity: 0; display: flex; flex-direction: column; align-items: center; 
            transition: opacity 2.5s ease, transform 3s cubic-bezier(0.1, 0.7, 0.1, 1), filter 3s ease; 
            z-index: 1; transform: scale(0.9); filter: blur(20px);
        }
        .title-cinematic { 
            font-family: 'Cinzel', serif; font-size: 3rem; 
            background: linear-gradient(to bottom, #FFD700, #B8860B, #FFD700); 
            -webkit-background-clip: text; background-clip: text; color: transparent; 
            text-align: center; letter-spacing: 4px; text-transform: uppercase; 
            filter: drop-shadow(0 0 30px rgba(255,215,0,0.4));
            line-height: 1.2;
        }
        .start-btn-cinematic { 
            margin-top: 60px; padding: 18px 60px; background: transparent; 
            border: 1px solid rgba(255,215,0,0.4); 
            color: var(--primary-gold); font-family: 'Cinzel'; font-weight: 600; letter-spacing: 4px; 
            cursor: pointer; font-size: 0.9rem; border-radius: 40px; 
            transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); 
            opacity: 0; transform: translateY(40px); filter: blur(10px);
        }
        .start-btn-cinematic.show-btn { opacity: 1; transform: translateY(0); filter: blur(0); }
        .start-btn-cinematic:hover { 
            background: rgba(255,215,0,0.05); border-color: var(--primary-gold);
            box-shadow: 0 0 50px rgba(255,215,0,0.3); letter-spacing: 6px; 
        }

        /* VFX & PARTICLES */
        .click-ripple {
            position: fixed; border-radius: 50%; pointer-events: none; z-index: 9998;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 60%);
            transform: translate(-50%, -50%) scale(0);
            animation: rippleEffect 0.6s linear forwards;
        }
        @keyframes rippleEffect { to { transform: translate(-50%, -50%) scale(4); opacity: 0; } }

        .flying-heart { position: fixed; z-index: 9999; pointer-events: none; font-size: 5rem; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); transition: all 1s cubic-bezier(0.2, 0.8, 0.2, 1); filter: drop-shadow(0 0 20px rgba(255,0,0,0.5)); }
        .flying-special { font-size: 8rem !important; filter: drop-shadow(0 0 50px gold) !important; z-index: 10000; }
        .float-score { position: fixed; z-index: 9999; font-weight: 800; font-size: 1.4rem; pointer-events: none; animation: floatUpFade 1.8s forwards; text-shadow: 0 4px 10px rgba(0,0,0,0.8); }
        @keyframes floatUpFade { 0% { opacity: 0; transform: translateY(10px) scale(0.5); filter: blur(5px); } 20% { opacity: 1; transform: translateY(0) scale(1.2); filter: blur(0); } 100% { opacity: 0; transform: translateY(-60px) scale(1); filter: blur(2px); } }
        
        .heart-cracking { display: inline-block; animation: crackShake 0.5s forwards; filter: grayscale(100%) brightness(0.5); }
        @keyframes crackShake { 0% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 50% { transform: rotate(-15deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0deg); } }
        .falling-piece { position: fixed; z-index: 9999; font-size: 1.5rem; pointer-events: none; color: #333; animation: gravityFall 1s cubic-bezier(0.5, 0, 1, 1) forwards; }
        @keyframes gravityFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(300px) rotate(180deg); opacity: 0; } }

        #red-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,0,0,0.4) 0%, transparent 80%); z-index: 9000; pointer-events: none; opacity: 0; transition: opacity 0.2s; mix-blend-mode: color-dodge; }
        .flash-active { opacity: 1 !important; }
        #sos-layer { position: fixed; top:0; left:0; width:100%; height:100%; opacity:0; pointer-events:none; z-index:50; mix-blend-mode: overlay; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,0,0,0.1) 4px); }
        
        #cinematic-text-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            z-index: 2000; pointer-events: none; opacity: 0; transition: opacity 2s ease; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); padding: 40px; 
        }
        .cinematic-msg { font-family: 'Playfair Display', serif; font-size: 2.2rem; color: #fff; text-align: center; text-shadow: 0 0 30px rgba(255,215,0,0.6); line-height: 1.5; transform: scale(1.1); transition: transform 4s; }

        /* RESULT SCREEN */
        #result-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #020617, #0f172a); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; opacity: 0; transition: opacity 2s ease; text-align: center; padding: 30px; }
        .score-box { width: 100%; max-width: 400px; margin: 40px 0; background: rgba(255,255,255,0.03); border-radius: 30px; padding: 35px; border: 1px solid rgba(255,215,0,0.2); box-shadow: 0 0 50px rgba(0,0,0,0.5); backdrop-filter: blur(20px); }
        .score-row { display: flex; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: 'Urbanist'; opacity: 0; transform: translateY(20px); filter: blur(5px); font-size: 1.15rem; }
        .score-row.anim-reveal { animation: cinematicReveal 1s forwards; }
        
        #year-text { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); 
            font-family: 'Cinzel', serif; font-size: 8vw; color: var(--primary-gold); 
            text-shadow: 0 0 60px rgba(255, 215, 0, 0.6), 0 0 20px rgba(255,215,0,0.8); 
            z-index: 60; 
            opacity: 0; pointer-events: none; letter-spacing: 10px; 
            text-align: center; width: 100%; font-weight: 800; filter: blur(30px); 
            transition: all 2.5s cubic-bezier(0.22, 1, 0.36, 1); 
            mix-blend-mode: screen;
        }
        #year-text.show { opacity: 1; transform: translate(-50%, -50%) scale(1); filter: blur(0px); }
        #year-text.dissolve { opacity: 0; transform: translate(-50%, -50%) scale(1.5); filter: blur(50px); }

        .card-container { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .promise-card { 
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); 
            border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 20px; 
            width: 105px; height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            cursor: pointer; opacity: 0; animation: cinematicReveal 1s forwards; 
            backdrop-filter: blur(15px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); 
            transition: 0.4s; 
        }
        .promise-card:hover { transform: translateY(-10px); box-shadow: 0 20px 50px rgba(255,215,0,0.2); border-color: gold; }
        
        .letter-card { 
            background: #fffdf5; color: #1a1a1a; padding: 40px; border-radius: 4px; 
            width: 90%; max-width: 340px; margin: 30px auto; 
            font-family: 'Dancing Script', cursive; font-size: 1.5rem; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.7); transform: rotate(-1deg) scale(0.9); 
            opacity: 0; animation: cinematicReveal 2s forwards; 
            position: relative;
        }
        .letter-card::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='paper'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.04' numOctaves='5'/%3E%3CfeDiffuseLighting lighting-color='%23fffdf5' surfaceScale='2'%3E%3CfeDistantLight azimuth='45' elevation='60'/%3E%3C/feDiffuseLighting%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paper)' opacity='0.5'/%3E%3C/svg%3E");
            opacity: 0.3; pointer-events: none; mix-blend-mode: multiply;
        }

    </style>
</head>
<body onclick="createClickRipple(event)">

    <audio id="uke-song" src="lagu.mp3" preload="auto"></audio>
    <audio id="bgm-song" src="lagu2.mp3" preload="auto" loop></audio>

    <div class="noise-overlay"></div>
    <div class="vignette-overlay"></div>
    <div class="ambient-orb orb-1"></div>
    <div class="ambient-orb orb-2"></div>
    <div class="ambient-orb orb-3"></div>

    <div id="bg-blue" class="bg-layer"></div>
    <div id="bg-purple" class="bg-layer"></div>
    <div id="bg-sunset" class="bg-layer"></div>

    <canvas id="global-canvas"></canvas> 
    <canvas id="snow-canvas"></canvas>
    <canvas id="lantern-canvas"></canvas>
    
    <canvas id="firework-canvas"></canvas> 
    
    <div id="frosted-glass-layer"></div>

    <canvas id="firefly-canvas"></canvas> 
    <canvas id="confetti-canvas"></canvas>
    
    <div id="red-screen"></div>
    <div id="notification">
        <span class="notif-icon"></span>
        <span class="notif-text"></span>
    </div>
    <div id="year-text">2026</div>

    <div id="cinematic-text-overlay">
        <div class="cinematic-msg" id="cinematic-msg"></div>
    </div>

    <div id="identity-overlay">
        <div class="id-box">
            <div style="font-family:'Cinzel'; color:var(--primary-gold); font-size:1.5rem; margin-bottom:25px; text-shadow:0 0 20px rgba(255,215,0,0.5);">Verifikasi Identitas</div>
            <input type="text" id="id-input" class="id-input" placeholder="Siapa namamu?" autocomplete="off">
            <button class="choice-btn" style="width:100%; opacity:1; transform:none; background:var(--primary-gold); color:black; font-weight:800; border:none; box-shadow:0 0 30px rgba(255,215,0,0.4);" onclick="verifyIdentity()">Beri tahu</button>
        </div>
    </div>

    <div id="start-overlay">
        <div id="click-catcher" onclick="startSequence()">
            <span style="font-size: 2.5rem; margin-bottom: 20px; text-shadow: 0 0 20px white;">‚úß</span>
            <span style="font-weight: 600; letter-spacing:6px;">TAP TO START</span>
        </div>
        <div class="title-container">
            <h1 class="title-cinematic">The Poet &<br>The Princess</h1>
            <button class="start-btn-cinematic" onclick="enterGame()">Buka Cerita</button>
        </div>
    </div>

    <div id="mobile-frame">
        <div class="header">
            <span class="header-title">The Poet</span>
            <div class="heart-counter">
                <span id="heart-icon" style="transition:0.3s; display:inline-block; filter: drop-shadow(0 0 5px rgba(255,0,0,0.5));">‚ù§Ô∏è</span> 
                <span id="heart-count" style="margin-left: 5px;">0</span> <span id="inventory" style="margin-left:5px"></span>
            </div>
        </div>

        <div id="sos-layer"></div>
        <div id="chat-content"></div>
        <div id="input-area"></div>
    </div>

    <div id="result-screen">
        <h1 style="font-family:'Cinzel'; color:var(--primary-gold); font-size:3rem; margin-bottom:10px; text-shadow: 0 0 40px var(--primary-gold); text-transform: capitalize;">The End</h1>
        
        <div class="score-box">
            <div class="score-row" id="row-red">
                <span>Hearts Collected</span>
                <span id="val-red" style="font-weight:bold;">0</span>
            </div>
            <div class="score-row" id="row-white">
                <span>White Heart (SOS)</span>
                <span id="val-white" style="font-weight:bold;">...</span>
            </div>
            <div class="score-row" id="row-gold">
                <span>Golden Heart</span>
                <span id="val-gold" style="font-weight:bold;">...</span>
            </div>
            <div class="score-row" id="row-total" style="border:none; margin-top:20px; color:var(--primary-gold); font-weight:800; font-size: 1.3rem;">
                <span>TOTAL SCORE</span>
                <span id="val-total">0 / 10</span>
            </div>
        </div>

        <p id="result-msg" style="font-family:'Urbanist'; font-size:1.1rem; max-width:85%; line-height:1.6; margin-bottom:40px; color:#ccc; text-shadow: 0 2px 4px rgba(0,0,0,0.5);"></p>
        <button onclick="location.reload()" class="choice-btn" style="opacity:1; transform:none; border-color:var(--primary-gold); color:var(--primary-gold); width: auto; padding-left: 40px; padding-right: 40px;">Ulangi Kisah</button>
    </div>

<script>
    // --- VFX HELPER ---
    function createClickRipple(e) {
        const ripple = document.createElement("div");
        ripple.className = "click-ripple";
        ripple.style.left = `${e.clientX}px`;
        ripple.style.top = `${e.clientY}px`;
        document.body.appendChild(ripple);
        setTimeout(() => ripple.remove(), 600);
    }

    // --- AUDIO SYSTEM ---
    const AudioSys = {
        ctx: null, masterGain: null,
        init: function() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            this.masterGain = this.ctx.createGain();
            this.masterGain.gain.value = 0.8; 
            this.masterGain.connect(this.ctx.destination);
            const o = this.ctx.createOscillator(); o.connect(this.masterGain); o.start(); o.stop(0.001);
        },
        createOsc: function(type, freq, t, dur, vol = 0.1, fadeOut=true) {
            if(!this.ctx) return;
            const o = this.ctx.createOscillator(); o.type = type; o.frequency.setValueAtTime(freq, t);
            const g = this.ctx.createGain(); 
            g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t + 0.02); 
            if(fadeOut) g.gain.exponentialRampToValueAtTime(0.001, t + dur); else g.gain.setValueAtTime(vol, t+dur);
            o.connect(g); g.connect(this.masterGain);
            o.start(t); o.stop(t + dur + 0.1);
        },
        play: function(key) {
            if(!this.ctx) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const t = this.ctx.currentTime;
            
            if(key === 'intro_click') { this.createOsc('sine', 800, t, 0.5, 0.2); }
            else if(key === 'narrative') { this.createOsc('sine', 400, t, 0.8, 0.05); this.createOsc('triangle', 600, t, 0.8, 0.02); }
            else if(key === 'type') { this.createOsc('triangle', 600 + (Math.random() * 200), t, 0.05, 0.05); } 
            else if(key === 'sent') { this.createOsc('sine', 400, t, 0.1, 0.2); this.createOsc('sine', 800, t+0.1, 0.1, 0.2); }
            else if(key === 'heaven') { [523, 659, 783, 1046, 1318].forEach((f,i) => setTimeout(() => this.createOsc('sine', f, t+i*0.05, 2.0, 0.1), i*50)); }
            else if(key === 'levelup') { this.createOsc('sine', 523.25, t, 0.3, 0.2); setTimeout(() => this.createOsc('sine', 783.99, t+0.1, 0.3, 0.2), 100); }
            else if(key === 'break') { this.createOsc('sawtooth', 100, t, 0.3, 0.2); }
            else if(key === 'error') { this.createOsc('square', 150, t, 0.2, 0.15); }
            else if(key === 'system') {
                const o = this.ctx.createOscillator(); o.type = 'sine'; o.frequency.setValueAtTime(800, t); o.frequency.linearRampToValueAtTime(1200, t+0.1);
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.5);
                o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+0.5);
            }
            else if(key === 'siren') { 
                const o = this.ctx.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(600, t); o.frequency.linearRampToValueAtTime(800, t+0.4); o.frequency.linearRampToValueAtTime(600, t+0.8);
                const g = this.ctx.createGain(); g.gain.value=0.15; o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+2);
            }
            else if(key === 'trail') {
                const o = this.ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(400, t); o.frequency.exponentialRampToValueAtTime(1200, t+1.0);
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+1.0);
                o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+1.1);
            }
            else if(key === 'firework') {
                const bs = this.ctx.sampleRate * 0.5; const buf = this.ctx.createBuffer(1, bs, this.ctx.sampleRate);
                const d = buf.getChannelData(0); for(let i=0; i<bs; i++) d[i] = (Math.random()*2-1) * Math.exp(-5*i/this.ctx.sampleRate);
                const src = this.ctx.createBufferSource(); src.buffer = buf;
                const f = this.ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 400;
                const g = this.ctx.createGain(); g.gain.value = 0.6;
                src.connect(f); f.connect(g); g.connect(this.masterGain); src.start(t);
            }
        }
    };

    // --- UI CONTROLLER ---
    const UI = {
        chat: document.getElementById('chat-content'),
        input: document.getElementById('input-area'),
        hearts: document.getElementById('heart-count'),
        heartContainer: document.querySelector('.heart-counter'),
        heartIcon: document.getElementById('heart-icon'),
        inv: document.getElementById('inventory'),
        sos: document.getElementById('sos-layer'),
        frame: document.getElementById('mobile-frame'),
        notif: document.getElementById('notification'),
        notifIcon: document.querySelector('.notif-icon'),
        notifText: document.querySelector('.notif-text'),
        redScreen: document.getElementById('red-screen'),
        yearText: document.getElementById('year-text'),
        bgCanvas: document.getElementById('global-canvas'),
        snowCanvas: document.getElementById('snow-canvas'),
        lanternCanvas: document.getElementById('lantern-canvas'),
        fwCanvas: document.getElementById('firework-canvas'),
        ffCanvas: document.getElementById('firefly-canvas'),
        result: document.getElementById('result-screen'),
        cinematicOverlay: document.getElementById('cinematic-text-overlay'),
        cinematicMsg: document.getElementById('cinematic-msg'),
        idOverlay: document.getElementById('identity-overlay'),
        idInput: document.getElementById('id-input'),
        idBox: document.querySelector('.id-box'),
        rRed: document.getElementById('val-red'),
        rWhite: document.getElementById('val-white'),
        rGold: document.getElementById('val-gold'),
        rTotal: document.getElementById('val-total'),
    };
    
    let state = { hearts: 0, gold: false, white: false };
    let isSnowing = false, isFireworks = false, isFireflies = false, isLanterns = false;
    let fireworkPhase = 'NONE'; 

    // --- UTILS ---
    function scrollDown() { setTimeout(() => { UI.chat.scrollTo({ top: UI.chat.scrollHeight, behavior: 'smooth' }); }, 100); }

    function startSequence() {
        AudioSys.init(); 
        AudioSys.play('intro_click');
        document.getElementById('click-catcher').style.opacity = 0;
        setTimeout(() => {
            document.getElementById('click-catcher').style.display = 'none';
            const title = document.querySelector('.title-container');
            title.style.opacity = 1; title.style.transform = "scale(1)"; title.style.filter = "blur(0)";
            setTimeout(() => { document.querySelector('.start-btn-cinematic').classList.add('show-btn'); }, 800);
        }, 800);
    }

    function enterGame() {
        AudioSys.play('levelup');
        const titleCont = document.querySelector('.title-container');
        titleCont.style.transform = "scale(2)"; titleCont.style.filter = "blur(30px)"; titleCont.style.opacity = 0;
        setTimeout(() => {
            document.getElementById('start-overlay').style.opacity = 0;
            setTimeout(() => { document.getElementById('start-overlay').style.display = 'none'; runScript(); }, 2000);
        }, 1000);
        initStarField(); 
        initSnow(); 
    }

    function poetChat(text, speed = 40) {
        return new Promise(resolve => {
            UI.input.innerHTML = ''; 
            const div = document.createElement('div');
            div.className = 'dialog-container poet-container';
            div.innerHTML = `<div class="dialog-label">Penyair</div><div class="dialog-box"></div>`;
            UI.chat.appendChild(div);
            const box = div.querySelector('.dialog-box');
            let i = 0; scrollDown();
            const int = setInterval(() => {
                box.textContent += text.charAt(i);
                if(i % 2 === 0) AudioSys.play('type');
                scrollDown(); i++;
                if(i>=text.length) { clearInterval(int); setTimeout(resolve, 600 + text.length*10); } 
            }, speed);
        });
    }

    function princessChat(text) {
        const div = document.createElement('div');
        div.className = 'dialog-container princess-container';
        div.innerHTML = `<div class="dialog-label">Tuan Putri</div><div class="dialog-box">${text}</div>`;
        UI.chat.appendChild(div);
        AudioSys.play('sent'); scrollDown();
    }

    function addNarrative(text) {
        return new Promise(resolve => {
            AudioSys.play('narrative');
            const div = document.createElement('div');
            div.className = 'narrative';
            div.innerHTML = text;
            UI.chat.appendChild(div);
            scrollDown(); setTimeout(resolve, 2000);
        });
    }

    function showInput(ph, cb) {
        UI.input.innerHTML = `<div class="input-wrap"><input type="text" id="userInput" class="text-input" placeholder="${ph}" autocomplete="off"><button class="send-btn" onclick="subIn()">‚û§</button></div>`;
        const el = document.getElementById('userInput'); el.focus(); scrollDown();
        el.addEventListener("keypress", function(event) { if (event.key === "Enter") window.subIn(); });
        window.subIn = function() { if(el.value.trim() === "") return; cb(el.value, el); }
    }

    function showOptions(opts) {
        UI.input.innerHTML = '';
        opts.forEach((o,i) => {
            const btn = document.createElement('div');
            btn.className = 'choice-btn';
            btn.innerText = o.text;
            btn.style.animationDelay = `${i*0.15}s`;
            btn.onclick = () => { 
                AudioSys.play('type'); 
                btn.style.transform = "scale(0.9)";
                setTimeout(() => { UI.input.innerHTML=''; o.action(); }, 250);
            };
            UI.input.appendChild(btn);
        });
        scrollDown();
    }

    function updateHearts(val, isGold = false) {
        const targetRect = UI.heartIcon.getBoundingClientRect();
        const targetX = targetRect.left + targetRect.width/2;
        const targetY = targetRect.top + targetRect.height/2;

        if (isGold) {
            state.hearts += val; UI.hearts.innerText = state.hearts; state.gold = true;
            AudioSys.play('heaven'); UI.inv.innerHTML += "üíõ";
            const fly = document.createElement('div'); fly.className = 'flying-heart flying-special'; fly.innerText = 'üíõ'; document.body.appendChild(fly);
            requestAnimationFrame(() => { fly.style.transform = "translate(-50%, -50%) scale(1)"; fly.style.opacity = 1; });
            setTimeout(() => { fly.style.left = targetX + 'px'; fly.style.top = targetY + 'px'; fly.style.transform = "translate(-50%, -50%) scale(0.1)"; fly.style.opacity = 0; }, 1500);
            setTimeout(() => fly.remove(), 2500); return;
        }

        if (val > 0) {
            const fly = document.createElement('div'); fly.className = 'flying-heart'; fly.innerText = '‚ù§Ô∏è'; document.body.appendChild(fly);
            requestAnimationFrame(() => { fly.style.transform = "translate(-50%, -50%) scale(1.5)"; fly.style.opacity = 1; });
            setTimeout(() => { fly.style.left = targetX + 'px'; fly.style.top = targetY + 'px'; fly.style.transform = "translate(-50%, -50%) scale(0.2)"; fly.style.opacity = 0; }, 800);
            setTimeout(() => {
                fly.remove(); state.hearts += val; UI.hearts.innerText = state.hearts; AudioSys.play('levelup'); UI.heartIcon.classList.add('heart-pump');
                
                // DYNAMIC POPUP TEXT
                const float = document.createElement('div'); float.className = 'float-score'; 
                float.innerText = `+${val} ‚ù§Ô∏è`; 
                float.style.color = "#4cd964"; float.style.left = targetX + 'px'; float.style.top = (targetY + 30) + 'px'; 
                document.body.appendChild(float); setTimeout(()=>float.remove(), 1500); setTimeout(()=>UI.heartIcon.classList.remove('heart-pump'), 400);
            }, 1600);
        } else {
            AudioSys.play('break'); UI.heartIcon.innerHTML = "üíî"; UI.heartIcon.classList.add('heart-cracking');
            const fall = document.createElement('div'); fall.className = 'falling-piece'; fall.innerText = "üíî"; fall.style.left = targetX + 'px'; fall.style.top = targetY + 'px'; document.body.appendChild(fall);
            setTimeout(() => {
                state.hearts += val; UI.hearts.innerText = state.hearts; UI.heartIcon.classList.remove('heart-cracking'); UI.heartIcon.innerHTML = "‚ù§Ô∏è";
                
                // DYNAMIC MINUS
                const float = document.createElement('div'); float.className = 'float-score'; 
                float.innerText = `${val} üíî`; 
                float.style.color = "#ff3b30"; float.style.left = targetX + 'px'; float.style.top = (targetY + 30) + 'px'; 
                document.body.appendChild(float); setTimeout(()=>float.remove(), 1500); fall.remove();
            }, 1000);
        }
    }

    function notifMsg(icon, txt, type) {
        UI.notifIcon.innerHTML = icon; UI.notifText.innerHTML = txt;
        if(type === 'gold') { UI.notifIcon.style.textShadow = "0 0 10px gold"; UI.notif.style.border = "1px solid var(--primary-gold)"; UI.notif.style.color="var(--primary-gold)"; }
        else if(type === 'white') { UI.notifIcon.style.textShadow = "0 0 10px white"; UI.notif.style.border = "1px solid white"; UI.notif.style.color="white"; }
        else if(type === 'system') { UI.notifIcon.style.textShadow = "0 0 10px #ff3b30"; UI.notif.style.border = "1px solid #ff3b30"; UI.notif.style.color="#ff3b30"; }
        else { UI.notifIcon.style.textShadow = "none"; UI.notif.style.border = "1px solid rgba(255,255,255,0.15)"; UI.notif.style.color="white"; }
        UI.notif.classList.add('show-notif'); setTimeout(() => UI.notif.classList.remove('show-notif'), 4000);
    }

    async function runScript() {
        await new Promise(r=>setTimeout(r,1000));
        await addNarrative("Kamu berjalan di tengah taman...");
        await addNarrative("Kamu menemukan ukulele di kursi taman.");
        showOptions([{ text: "[Ambil] ‚úã", action: sceneUkulele }, { text: "[Percayakan keputusan pada hatimu] ‚ú®", action: sceneUkulele }]);
    }

    async function sceneUkulele() {
        await addNarrative("Kamu mengambil Ukulele.");
        await addNarrative("Jreng Jreng Jreng... (Petikan Ukulelemu sangat buruk)");
        await poetChat("WEH, Ukulele gw!");
        await poetChat("Kalo mau nyuri seengganya bisa mainin!");
        await poetChat("Bentar... kamu kayak ga asing.");
        await poetChat("Siapa kamu?");
        askName();
    }

    function askName() {
        UI.idOverlay.style.display = 'flex';
        setTimeout(() => { UI.idOverlay.style.opacity = 1; UI.idOverlay.classList.add('id-active'); }, 50);
        document.getElementById('id-input').focus();
    }

    function verifyIdentity() {
        const val = document.getElementById('id-input').value.toLowerCase();
        const keys = ['aksa', 'cila', 'cilla', 'priscilla', 'tante', 'ayang', 'sayang', 'pacar', 'kaka', 'kakak', 'kak', 'nanda', 'putri', 'tuan'];
        if(keys.some(k=>val.includes(k))) {
            AudioSys.play('levelup'); UI.idOverlay.style.opacity = 0; UI.idOverlay.classList.remove('id-active');
            setTimeout(() => { UI.idOverlay.style.display = 'none'; proceed(); }, 800);
        } else {
            AudioSys.play('error');
            const box = document.querySelector('.id-box'); box.classList.remove('shake-hard'); void box.offsetWidth; box.classList.add('shake-hard');
            UI.redScreen.classList.add('flash-active'); setTimeout(()=> UI.redScreen.classList.remove('flash-active'), 200);
            const input = document.getElementById('id-input'); input.value = ''; input.placeholder = "Oh, aku salah orang..."; input.style.borderColor = "red"; setTimeout(() => input.style.borderColor = "rgba(255,255,255,0.2)", 1500);
        }
    }

    async function proceed() {
        await poetChat("Eh kirain siapa, ternyata Tuan Putri");
        AudioSys.play('system'); notifMsg("‚ù§Ô∏è", "HEART SYSTEM ACTIVATED", "system");
        UI.heartContainer.classList.add('reveal');
        await new Promise(r=>setTimeout(r, 2000));
        updateHearts(1);
        await poetChat("Lama ga ketemu yaa"); await poetChat("Udah deket penghujung tahun ya, gak kerasa."); await poetChat("Btw..."); await poetChat("Sini Ukulelenya gw mainin, mau denger gaa?");
        showOptions([{ text: "Wih sok banget, emang bisa? Wkwk coba deh üòè", action: ()=>q1('A') }, { text: "Gausah, nanti u malu maluin üôÑ", action: ()=>q1('B') }]);
    }

    async function q1(c) {
        UI.input.innerHTML = '';
        const s1 = document.getElementById('uke-song'); const s2 = document.getElementById('bgm-song');
        if(c=='A') { princessChat("Widih sok banget, emang bisa? Wkwk coba deh üòè"); updateHearts(1); await poetChat("Yee ngeremehin üòé"); await poetChat("Ehem ehem... üé§üé∏"); if(s1) { s1.currentTime = 0; s1.play().catch(e=>{}); } await new Promise(r => setTimeout(r, 5000)); q2(); } 
        else { princessChat("Gausah, nanti malu maluin üôÑ"); updateHearts(-1); await poetChat("Yaudaa yaudaaa engga gw mainin"); if(s2) { s2.currentTime = 0; s2.play().catch(e=>{}); } q2(); }
    }

    async function q2() {
        await poetChat("Inget gak dulu u pernah pamerin mainin lagu Blue - Yung kai pake ukulele estetik u itu?");
        showOptions([{ text: "HAHAHA si anj, inget aja loh üòÇ", action: ()=>q2r('A') }, { text: "Emang iya ya? i ga inget ah ü§î", action: ()=>q2r('B') }, { text: "Inget dongg, sekeren itu kan i sampe u ingett HAHAHA üòé", action: ()=>q2r('C') }]);
    }

    async function q2r(c) {
        if(c=='A') { princessChat("HAHAHA si anj, inget aja loh üòÇ"); updateHearts(1); await poetChat("Siapa si yang ga inget malem-malem u gabisa tidur terus pamer skill yang u bangga-banggakan itu"); }
        else if(c=='B') { princessChat("Emang iya ya? i ga inget ah ü§î"); updateHearts(-1); await poetChat("Yeuu kocak"); }
        else { princessChat("Inget dongg, sekeren itu kan i sampe u ingett HAHAHA üòé"); updateHearts(3); await poetChat("woiyaaa jelas dong, gw selalu bangga punya u waktu itu wkwk"); }
        q3();
    }

    async function q3() {
        await poetChat("Masih sering latihan mainin gak?");
        showOptions([{ text: "Aduh dimana yak Ukulele i, udah ketimbun debu kayanya üíÄ", action: ()=>q3r('A') }, { text: "MASIH DONG! i bisa mainin banyak lagu sekarang üé∏", action: ()=>q3r('B') }, { text: "Kalo gabut doang i mainin üò∂", action: ()=>q3r('C') }]);
    }

    async function q3r(c) {
        if(c=='A') { princessChat("Aduh dimana yak Ukulele i, udah ketimbun debu kayanya üíÄ"); updateHearts(-2); await poetChat("BERSIHIN KAMAR GAK U SEKARANG! üî™"); await poetChat("Masih sering berantakan kayak waktu itu pasti, baju numpuk dimana-mana"); }
        else if(c=='B') { princessChat("MASIH DONG! i bisa mainin banyak lagu sekarang üé∏"); updateHearts(3); await poetChat("Makin bangga aja lagi gw sama u"); }
        else { princessChat("Kalo gabut doang i mainin üò∂"); updateHearts(1); await poetChat("Yaudalaa, seengganya gabutnya ga buka live tiktok Batik Christo lagi"); }
        q4();
    }

    async function q4() {
        await poetChat("Jadi... gimana sama yang sekarang?");
        showOptions([{ text: "Puji Tuhan, Alhamdulillah yaa aman terkendali. üòá", action: ()=>q4r('A') }, { text: "Udah engga lanjut nih üòÆ‚Äçüí®", action: ()=>q4r('B') }, { text: "i butuh u. üÜò", action: ()=>q4r('C') }]);
    }

    async function q4r(c) {
        if(c=='A') { princessChat("Puji Tuhan, Alhamdulillah yaa aman terkendali. üòá"); updateHearts(1); await poetChat("Alhamdulillah, puji tuhan, semoga langgeng, lancar semua dan selalu baik-baik aja yaa, gw ikut seneng u sama dia"); nextFinal(); }
        else if(c=='B') { princessChat("Udah engga lanjut nih üòÆ‚Äçüí®"); updateHearts(1); await poetChat("Tu kan mending sama gw anjir, wkwk"); await poetChat("Tapi ya, semoga u bisa tau ya apa yang u butuh sebenernya, karena apa yang paling u mau terkadang bukan yang sebenernya paling u butuhin"); nextFinal(); }
        else { princessChat("i butuh u. üÜò"); await poetChat("jawab yang bener"); showOptions([{ text: "Iya i serius loh ü•∫", action: sosTrigger }, { text: "hehe maaf cuman iseng jawab gitu üòú", action: ()=>{ princessChat("hehe maaf.."); q4(); } }]); }
    }

    async function sosTrigger() {
        princessChat("Iya i serius loh ü•∫"); AudioSys.play('siren'); state.white = true; updateHearts(1); UI.inv.innerHTML += "ü§ç"; UI.sos.style.animation = "sosFlash 0.5s 3"; notifMsg("üîî", "FUNFACT : NOMOR WA PENYAIR MASIH SAMA...", "white");
        await poetChat("RED CODE!! üö® Meluncurkan rudal pelukan dan ciuman! Bertahan di sana, bantuan datang!");
        showOptions([ { text: "Chat Sekarang üí¨", action: chatWhatsApp }, { text: "Nanti Aja Deh üçÇ", action: () => { princessChat("Nanti Aja Deh üçÇ"); poetChat("Okee simpen dulu aja").then(nextFinal); } } ]);
    }

    function chatWhatsApp() {
        let myNumber = "62895328424441"; let msg = "*S.O.S* _Cila butuh adick Aksa_";
        window.open(`https://wa.me/${myNumber}?text=${encodeURIComponent(msg)}`, '_blank');
        princessChat("Chat Sekarang üí¨"); poetChat("Ditunggu notifnya ya...").then(nextFinal);
    }

    async function nextFinal() {
        await poetChat("Gw keasikan ngobrol sampe lupa nanya, gimana kabar u...?"); await poetChat("Tuan Putri.. Cila?");
        showOptions([{ text: "Puji Tuhan, Alhamdulillah, semua aman-aman aza ko, BEST! ‚ú®", action: ()=>fin('A') }, { text: "Ya gitu-gitu ajaa sii üòê", action: ()=>fin('B') }, { text: "Puji Tuhan baik semuaa, tapi kangen adik penyair i ü•∫üíõ", action: ()=>fin('C') }]);
    }

    async function fin(c) {
        if(c=='A') { princessChat("Puji Tuhan, Alhamdulillah, semua aman-aman aza ko, BEST! ‚ú®"); updateHearts(1); }
        else if(c=='B') { princessChat("Ya gitu-gitu ajaa sii üòê"); updateHearts(-2); await poetChat("Niatan dikit kek jawabnyaa, yee kocak"); }
        else { princessChat("Puji Tuhan baik semuaa, tapi kangen adik penyair i ü•∫üíõ"); updateHearts(1, true); await addNarrative("Achievement: Happily Never After"); }
        phaseChristmas();
    }

    async function phaseChristmas() {
        await new Promise(r=>setTimeout(r, 1000));
        UI.chat.style.transition = "opacity 1.5s";
        UI.chat.style.opacity = 0;
        await new Promise(r=>setTimeout(r, 1500));
        UI.chat.innerHTML = '';
        UI.chat.style.opacity = 1;
        await poetChat("Kayanya, salju mulai turun...");
        const s2 = document.getElementById('bgm-song');
        if(s2 && s2.paused) s2.play().catch(e=>{});
        await new Promise(r=>setTimeout(r, 1000));
        isSnowing = true;
        await poetChat("Loh... bukannya kita ada di indonesia yak ü§®"); 
        await new Promise(r=>setTimeout(r, 1000));
        const m = ["Oh iyaa, Selamat Natal yaa..","Jujur, u berarti banget buat gw sebagai apapun","Bahkan sama u terakhir kali gw ngerasain punya kakak yang sesayang dan sepeduli itu sama gw...","Tahun baru nanti, dan tahun-tahun berikutnya..","Gw selalu doain yang terbaik buat u","Meskipun terlambat, Selamat Natal..."];
        for(let t of m) { await poetChat(t, 55); await new Promise(r=>setTimeout(r, 1500)); }
        triggerNewYearScene();
    }

    // --- PHASE: NEW YEAR ---
    async function triggerNewYearScene() {
        // Step 0: Fade Out Chat
        await new Promise(r=>setTimeout(r, 2000));
        UI.chat.style.transition = "opacity 2s";
        UI.chat.style.opacity = 0; 
        isSnowing = false; 

        await new Promise(r=>setTimeout(r, 1500));
        
        // Step 1: 2026 Appears & Royal Mode
        const yTxt = UI.yearText;
        yTxt.classList.add('show'); 
        
        document.body.classList.add('royal-mode'); // BG Change (Force Purple)
        isFireworks = true;
        fireworkPhase = 'SCRIPTED'; 
        UI.fwCanvas.style.opacity = 1;

        // Step 2: Trail Lurus ke Tengah
        setTimeout(() => { 
            window.launchCenterFirework(); 
        }, 1000);

        // Step 3: Text Change to "Selamat Tahun Baru"
        setTimeout(() => {
            yTxt.classList.remove('show');
            yTxt.classList.add('dissolve'); 
            setTimeout(() => {
                yTxt.innerText = "Selamat Tahun Baru!";
                yTxt.classList.remove('dissolve');
                yTxt.classList.add('show'); 
            }, 2000); 
        }, 3000);

        // Step 4: Explosions (WITH SOUND)
        setTimeout(() => { window.launchRandomFirework(true); }, 4000);
        setTimeout(() => { window.launchRandomFirework(true); }, 5000);
        setTimeout(() => { window.launchRandomFirework(true); }, 6000);
        setTimeout(() => { window.launchRandomFirework(true); }, 7000);

        // Step 5: Ambience (SILENT LOOP)
        setTimeout(() => { fireworkPhase = 'AMBIENCE'; }, 8000);

        // End Phase
        await new Promise(r=>setTimeout(r, 12000)); 
        
        yTxt.classList.remove('show'); 
        yTxt.style.display = 'none';
        
        UI.chat.innerHTML = '';
        UI.chat.style.opacity = 1;
        
        await poetChat("Selamat udah namatin level 2025 dengan keren!", 60);
        await new Promise(r=>setTimeout(r, 1000));
        await poetChat("Bener-bener ga kerasa yaa.", 60);
        await poetChat("Makasih buat tahun kemaren, buat semua kenangan jadi partner in crimenya.", 60);
        await poetChat("Kalo mau nyari partner in crime lagi, inget u selalu punya adik keren ini yaa.", 60);

        runPhaseWish();
    }

    async function runPhaseWish() {
        await poetChat("Tahun ini apa yang mau u capai?", 60);
        await poetChat("Mau naklukin apa lagi?", 60);
        await poetChat("Kasih tau yaa, bakal gw kasih Aamiin paling serius", 60);
        await poetChat("dua agama kurang powerful apa wkwk", 60);
        showInput("Tulis harapanmu...", (val) => { princessChat(val); UI.input.innerHTML = ''; runPhaseLetter(val); });
    }

    async function runPhaseLetter(wishText) {
        await new Promise(r=>setTimeout(r, 1000));
        const letter = document.createElement('div');
        letter.className = 'letter-card';
        letter.innerHTML = `<div style="border-bottom:1px solid rgba(0,0,0,0.1); margin-bottom:15px; padding-bottom:5px; font-size:1rem; opacity:0.6;">Dear God, Aku berharap... </div><div style="margin-bottom:20px; font-size:1.6rem; line-height:1.4;">"${wishText}"</div><div style="text-align:right; font-size:1rem; margin-top:10px;">Priscilla A.T.</div>`;
        UI.chat.appendChild(letter); scrollDown(); AudioSys.play('heaven');
        await new Promise(r=>setTimeout(r, 3500));
        UI.cinematicMsg.innerText = "Semoga doa yang u harapkan tercapai, apapun itu";
        UI.cinematicOverlay.style.opacity = 1;
        await new Promise(r=>setTimeout(r, 4500));
        UI.cinematicOverlay.style.opacity = 0; 
        if(state.gold) goldenPromise(); else finalTransition();
    }

    function goldenPromise() {
        setTimeout(() => {
            isFireworks = false; UI.fwCanvas.style.opacity = 0; UI.chat.innerHTML = ""; 
            isFireflies = true; UI.ffCanvas.style.opacity = 1;
            document.body.classList.remove('royal-mode'); 
            notifMsg("‚ú®", "Achievement Unlocked: Golden Promise", "gold");
            const title = document.createElement('div'); title.innerHTML = "<h2 style='font-family:Cinzel; color:#FFD700; text-align:center; text-shadow:0 0 30px #FFD700; opacity:0; animation:cinematicReveal 1.5s forwards'>Chapter : The Golden Promise</h2>"; UI.chat.appendChild(title);
            const sub = document.createElement('div'); sub.innerHTML = "<p style='text-align:center; color:#ddd; font-size:0.95rem; margin:20px; line-height:1.6; opacity:0; animation:cinematicReveal 1.5s 0.5s forwards'>Karena telah mendapatkan Golden Heart, u bisa memilih di kehidupan selanjutnya, ingin reinkarnasi jadi apa?</p>"; UI.chat.appendChild(sub);
            const container = document.createElement('div'); container.className = 'card-container';
            const cards = [ { id: 'pasangan', icon: 'üíç', label: 'Pasangan' }, { id: 'kakak', icon: 'üõ°Ô∏è', label: 'Kakak' }, { id: 'bestie', icon: 'ü§û', label: 'Bestie' } ];
            cards.forEach((c, i) => {
                const card = document.createElement('div'); card.className = 'promise-card';
                card.style.animationDelay = (1 + i*0.2) + "s";
                card.innerHTML = `<div style="font-size:2.8rem; margin-bottom:10px; filter:drop-shadow(0 0 10px rgba(255,255,255,0.4))">${c.icon}</div><div style="font-size:0.8rem; text-transform:uppercase; font-weight:700; letter-spacing:1px">${c.label}</div>`;
                card.onclick = () => melancholy(c.id); container.appendChild(card);
            });
            UI.chat.appendChild(container); scrollDown();
        }, 2000);
    }

    async function melancholy(choice) {
        UI.chat.innerHTML = ''; let reply = "";
        if(choice === 'pasangan') reply = "Semoga kita terikat di kehidupan selanjutnya sebagai pasangan paling hangat sedunia. Btw, bakal gimana \"Ketidaksengajaan\" yang pertemuin kita nanti ya...";
        if(choice === 'kakak') reply = "Semoga yaa, tapi u jangan galak-galak sama adick u inii, nanti kita pasti jadi duo troublemaker wkwk";
        if(choice === 'bestie') reply = "Lucu juga ya, entah bakal jadi partner in crime macam apa kitaa";
        await poetChat(reply, 60); await new Promise(r=>setTimeout(r, 2000));
        const finalDiv = document.createElement('div'); finalDiv.style.cssText = "text-align:center; margin-top:50px; font-family:Cinzel; font-size:1.2rem; color:#fff; text-shadow:0 0 15px gold; opacity:0; transition:opacity 2.5s; line-height:1.6;";
        finalDiv.innerText = "Apapun itu gw janji bakal sayangin u, bahkan kalo itu dikehidupan selanjutnya";
        UI.chat.appendChild(finalDiv); scrollDown(); setTimeout(() => finalDiv.style.opacity = '1', 100);
        await new Promise(r=>setTimeout(r, 6000)); finalTransition();
    }

    function finalTransition() {
        document.getElementById('mobile-frame').style.opacity = 0; 
        AudioSys.play('firework'); AudioSys.play('confetti'); startConfetti();
        
        // CHECK IF MAGICAL PERFECT (10 + Gold + White)
        // Score Logic: Total is collected hearts. Check logic.
        // Intro(1) + Uke(1) + YungKai(3) + Practice(3) + Ex(1) + Final(1) = 10.
        // If Magical: state.hearts = 10, state.gold = true, state.white = true.
        
        if (state.hearts >= 10 && state.gold && state.white) {
            magicalSunset();
        }

        // FORCE DISPLAY RESULT
        UI.result.style.display = 'flex';
        void UI.result.offsetWidth; // Force Reflow
        setTimeout(() => UI.result.style.opacity = 1, 100);
        setTimeout(animateResult, 1500);
    }

    // --- MAGICAL ENDING LOGIC ---
    function magicalSunset() {
        document.body.classList.add('magical-mode'); // Trigger BG Change
        isSnowing = false; // Stop Snow
        initLanterns(); // Start Lanterns
        isLanterns = true;
    }

    function animateResult() {
        let totalScore = state.hearts;
        // Display Red = Total - Specials (Logic: Total 10, White 1, Gold 1 => Red 8)
        let displayRed = totalScore - (state.white?1:0) - (state.gold?1:0); 
        
        setTimeout(() => { document.getElementById('row-red').classList.add('anim-reveal'); countUp(UI.rRed, displayRed); }, 500);
        setTimeout(() => { document.getElementById('row-white').classList.add('anim-reveal'); if(state.white) { document.getElementById('val-white').innerHTML = "<span style='color:white; text-shadow:0 0 10px white'>FOUND (+1)</span>"; AudioSys.play('levelup'); } else { document.getElementById('val-white').innerHTML = "<span style='color:#555'>MISSING</span>"; AudioSys.play('error'); } }, 1500);
        setTimeout(() => { document.getElementById('row-gold').classList.add('anim-reveal'); if(state.gold) { document.getElementById('val-gold').innerHTML = "<span style='color:gold; text-shadow:0 0 10px gold'>FOUND (+1)</span>"; AudioSys.play('heaven'); } else { document.getElementById('val-gold').innerHTML = "<span style='color:#555'>MISSING</span>"; AudioSys.play('error'); } }, 2500);
        
        setTimeout(() => {
            document.getElementById('row-total').classList.add('anim-reveal'); document.getElementById('val-total').innerText = totalScore + " / 10"; AudioSys.play('intro_click');
            
            let msg = ""; 
            if (totalScore < 5) msg="APAAN SEGINI DOANG, GA ABIS PIKIR GW üóø. Ulangi lagi gih!"; 
            else if (totalScore < 8) msg="Not bad lah. Tapi tetep aja kocak dapet segitu doang! ü§®"; 
            else if (totalScore < 10) msg="Wihh keren! Hampir sempurna, dikit lagi! ‚ú®"; 
            else if (totalScore === 10 && (!state.gold || !state.white)) msg="PERFECT SCORE! 10/10 üèÜ Bener-bener Tuan Putri terbaik. Gw bangga banget punya kakak kaya u! ‚ù§Ô∏è"; 
            else if (totalScore >= 10 && state.gold && state.white) msg="U emang BEST!! ü§Ø. Cieee mainnya pake hati, tapi u sekeren itu loh dapet semua, bangga banget sama u, Sayang...";
            
            document.getElementById('result-msg').innerText = msg;
        }, 3500);
    }
    function countUp(el, max) { let curr = 0; if(max <= 0) { el.innerText = 0; return; } let int = setInterval(() => { curr++; el.innerText = curr; if(curr >= max) clearInterval(int); }, 80); }

    // --- VISUAL ENGINE (FINAL PERFECTED) ---
    function setupCanvas(c) { c.width = window.innerWidth; c.height = window.innerHeight; return c.getContext('2d'); }
    
    // 1. STAR FIELD (BACKGROUND) - Always visible
    function initStarField() {
        const ctx = setupCanvas(UI.bgCanvas);
        const stars = Array(150).fill().map(() => ({ 
            x: Math.random()*window.innerWidth, 
            y: Math.random()*window.innerHeight, 
            r: Math.random()*1.8, 
            v: Math.random()*0.3 + 0.1, 
            opacity: Math.random()*0.7 + 0.3 
        })); 
        function loop() {
            ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
            stars.forEach(s => { 
                ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); 
                let alpha = s.opacity + (Math.sin(Date.now() * 0.003 * s.v) * 0.2); if(alpha<0) alpha=0;
                ctx.fillStyle = `rgba(255, 215, 0, ${alpha})`; 
                if(s.r > 1.2) { ctx.shadowBlur = 8; ctx.shadowColor = "rgba(255, 215, 0, 0.5)"; } else { ctx.shadowBlur = 0; }
                ctx.fill(); s.y -= s.v; if(s.y < 0) { s.y = window.innerHeight; s.x = Math.random()*window.innerWidth; } 
            });
            requestAnimationFrame(loop);
        } loop();
    }

    // 2. SNOW (Dedicated)
    function initSnow() {
        const ctx = setupCanvas(UI.snowCanvas);
        const snowBack = Array(50).fill().map(() => ({ x: Math.random()*window.innerWidth, y: Math.random()*-window.innerHeight, r: Math.random()*1.5+0.5, v: Math.random()*0.5+0.5, opacity: Math.random()*0.3 + 0.1 })); 
        const snowFront = Array(15).fill().map(() => ({ x: Math.random()*window.innerWidth, y: Math.random()*-window.innerHeight, size: Math.random()*15 + 10, v: Math.random()*1.5+1, spin: Math.random() * 360, spinSpeed: (Math.random()-0.5) * 2 })); 
        
        function loop() {
            ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
            if(isSnowing) {
                ctx.fillStyle = "rgba(255,255,255,0.4)"; 
                snowBack.forEach(f => { ctx.beginPath(); ctx.globalAlpha = f.opacity; ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill(); f.y += f.v; f.x += Math.sin(f.y/50)*0.3; if(f.y > window.innerHeight) { f.y = -10; f.x = Math.random()*window.innerWidth; } });
                ctx.fillStyle = "white"; ctx.globalAlpha = 1; ctx.shadowBlur = 10; ctx.shadowColor = "white"; ctx.font = "20px sans-serif";
                snowFront.forEach(f => { ctx.save(); ctx.translate(f.x, f.y); ctx.rotate(f.spin * Math.PI/180); ctx.font = `${f.size}px sans-serif`; ctx.fillText("‚ùÑ", 0, 0); ctx.restore(); f.y += f.v; f.x += Math.sin(f.y/30)*0.5; f.spin += f.spinSpeed; if(f.y > window.innerHeight + 50) { f.y = -50; f.x = Math.random()*window.innerWidth; } });
                ctx.shadowBlur = 0;
            }
            requestAnimationFrame(loop);
        } loop();
    }

    // 2.5 LANTERNS (MAGICAL ENDING)
    function initLanterns() {
        const ctx = setupCanvas(UI.lanternCanvas);
        UI.lanternCanvas.style.opacity = 1;
        const lanterns = Array(40).fill().map(() => ({ 
            x: Math.random()*window.innerWidth, 
            y: window.innerHeight + Math.random()*500, 
            w: Math.random()*15 + 10,
            h: Math.random()*20 + 15,
            v: Math.random()*0.8 + 0.2, 
            sway: Math.random()*0.5,
            offset: Math.random()*100
        }));
        
        function loop() {
            ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
            if(isLanterns) {
                lanterns.forEach(l => {
                    ctx.save();
                    ctx.translate(l.x + Math.sin((l.y+l.offset)/50)*20, l.y);
                    
                    // Glow
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = "rgba(255, 165, 0, 0.5)";
                    
                    // Lantern Body
                    const grad = ctx.createLinearGradient(0,0,0,l.h);
                    grad.addColorStop(0, "rgba(255, 200, 0, 0.8)");
                    grad.addColorStop(1, "rgba(255, 140, 0, 0.4)");
                    ctx.fillStyle = grad;
                    ctx.fillRect(-l.w/2, -l.h/2, l.w, l.h);
                    
                    // Light Center
                    ctx.fillStyle = "#fff";
                    ctx.beginPath(); ctx.arc(0, 0, l.w/4, 0, Math.PI*2); ctx.fill();
                    
                    ctx.restore();
                    
                    l.y -= l.v;
                    if(l.y < -50) { l.y = window.innerHeight + 50; l.x = Math.random()*window.innerWidth; }
                });
                
                // Gold Dust
                ctx.fillStyle = "rgba(255, 215, 0, 0.6)";
                for(let i=0; i<30; i++) {
                    ctx.fillRect(Math.random()*window.innerWidth, Math.random()*window.innerHeight, 2, 2);
                }
            }
            requestAnimationFrame(loop);
        } loop();
    }

    // 3. FIREWORKS (ROUND PHYSICS)
    function initFireworks() {
        const ctx = setupCanvas(UI.fwCanvas); let particles = [];
        
        window.launchCenterFirework = () => { AudioSys.play('trail'); setTimeout(() => { createExplosion(window.innerWidth/2, window.innerHeight/2); AudioSys.play('firework'); }, 1000); };
        window.launchRandomFirework = (forceSound = false) => { createExplosion(Math.random()*window.innerWidth, Math.random()*window.innerHeight*0.6); if(forceSound) { AudioSys.play('firework'); } };

        function createExplosion(x,y) { 
            const palette = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF', '#FFA500', '#FFFFFF'];
            const particleCount = 100; // Optimized count
            for(let i=0; i<particleCount; i++) { 
                // Distribute evenly in a circle (Polar coordinates)
                const angle = (Math.PI * 2 * i) / particleCount;
                const speed = Math.random() * 8 + 5; 
                
                particles.push({
                    x, y, 
                    vx: Math.cos(angle) * speed, 
                    vy: Math.sin(angle) * speed, 
                    color: palette[Math.floor(Math.random()*palette.length)], 
                    alpha: 1, 
                    decay: Math.random() * 0.015 + 0.01,
                    trail: [] 
                }); 
            } 
        }
        
        function loop() {
            ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

            // AUTO LOOPING (Silent)
            if(fireworkPhase === 'AMBIENCE') {
                if(Math.random() < 0.04) { 
                    window.launchRandomFirework(false); 
                }
            }

            if(isFireworks || particles.length > 0) {
                particles.forEach((p,i) => { 
                    // PHYSICS CHANGE: High Friction, Low Gravity
                    p.vx *= 0.92; // Slows down horizontally
                    p.vy *= 0.92; // Slows down vertically
                    p.vy += 0.005; // Almost no gravity, prevents "sagging"
                    
                    p.x += p.vx; p.y += p.vy; p.alpha -= p.decay; 
                    
                    p.trail.push({x: p.x, y: p.y});
                    if(p.trail.length > 5) p.trail.shift();

                    if(p.alpha <= 0) {
                        particles.splice(i,1);
                    } else {
                        // Draw Trail
                        ctx.beginPath();
                        ctx.strokeStyle = p.color;
                        ctx.lineWidth = 2;
                        ctx.globalAlpha = p.alpha * 0.5;
                        if(p.trail.length > 1) {
                            ctx.moveTo(p.trail[0].x, p.trail[0].y);
                            for(let t of p.trail) ctx.lineTo(t.x, t.y);
                            ctx.stroke();
                        }
                        // Draw Head
                        ctx.globalAlpha = p.alpha;
                        ctx.fillStyle = "white";
                        ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                    }
                });
            } 
            requestAnimationFrame(loop);
        } loop();
    }
    
    function initFireflies() { const ctx = setupCanvas(UI.ffCanvas); const flies = Array(30).fill().map(() => ({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, s: Math.random()*3, a: Math.random(), da: 0.02 })); function loop() { ctx.clearRect(0,0,window.innerWidth,window.innerHeight); if(isFireflies) { flies.forEach(f => { ctx.beginPath(); ctx.arc(f.x, f.y, f.s, 0, Math.PI*2); ctx.fillStyle = `rgba(255, 215, 0, ${f.a})`; ctx.fill(); f.a += f.da; if(f.a<=0 || f.a>=1) f.da *= -1; f.x += (Math.random()-0.5); f.y += (Math.random()-0.5); }); } requestAnimationFrame(loop); } loop(); }
    function startConfetti() { const ctx = setupCanvas(document.getElementById('confetti-canvas')); const confs = Array(120).fill().map(()=>({x:window.innerWidth/2, y:window.innerHeight/2, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15-5, c:`hsl(${Math.random()*360},100%,50%)`})); function loop() { ctx.clearRect(0,0,window.innerWidth,window.innerHeight); confs.forEach(p=>{ ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,6,6); p.x+=p.vx; p.y+=p.vy; p.vy+=0.3; }); requestAnimationFrame(loop); } loop(); }

    window.addEventListener('resize', () => { UI.bgCanvas.width = window.innerWidth; UI.bgCanvas.height = window.innerHeight; UI.fwCanvas.width = window.innerWidth; UI.fwCanvas.height = window.innerHeight; UI.ffCanvas.width = window.innerWidth; UI.ffCanvas.height = window.innerHeight; UI.snowCanvas.width = window.innerWidth; UI.snowCanvas.height = window.innerHeight; UI.lanternCanvas.width = window.innerWidth; UI.lanternCanvas.height = window.innerHeight; });
    initFireworks(); initFireflies();
</script>
</body>
</html>
