<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>The Poet & The Princess</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Urbanist:wght@300;400;600;700;800&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">

    <style>
        /* --- VISUAL CORE: LIVING ATMOSPHERE --- */
        :root {
            --primary-gold: #FFD700;
            --soft-gold: #FFE5B4;
            --glass-border: 1px solid rgba(255, 255, 255, 0.12);
            --poet-bubble: rgba(30, 41, 59, 0.65);
            --princess-bubble: rgba(20, 184, 166, 0.25);
            
            /* Background Gradients */
            --bg-midnight: linear-gradient(135deg, #020a1a, #0d1b33, #1a2a47, #050c1f);
            --bg-royal: linear-gradient(135deg, #240b36, #2d1b4e, #512b58, #1a0524); /* Ungu Estetik */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%; height: 100dvh; width: 100%;
            overflow: hidden; font-family: 'Urbanist', sans-serif; color: white;
            background: #020a1a;
        }

        /* DYNAMIC BACKGROUND LAYER */
        #dynamic-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: var(--bg-midnight);
            background-size: 400% 400%;
            animation: auroraFlow 20s ease infinite;
            transition: background 3s ease-in-out; /* Smooth transition 3 detik */
        }
        
        /* State Class for New Year Phase (Ungu) */
        #dynamic-bg.phase-royal {
            background: var(--bg-royal) !important;
            background-size: 400% 400%;
        }

        @keyframes auroraFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* LAYERS */
        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #global-canvas { z-index: 1; opacity: 1; }
        
        /* KEMBANG API BLUR (BOKEH EFFECT) */
        #firework-canvas { 
            z-index: 2; opacity: 0; transition: opacity 1s; 
            filter: blur(15px) contrast(1.2); /* Efek pendaran cahaya lembut */
        }
        
        #firefly-canvas { z-index: 3; opacity: 0; transition: opacity 1s; }
        #confetti-canvas { z-index: 9999; }
        
        /* FRAME UTAMA */
        #mobile-frame {
            position: relative; width: 100%; height: 100%; max-width: 480px; margin: 0 auto;
            display: flex; flex-direction: column; z-index: 10;
            background: rgba(0,0,0,0.05); 
            box-shadow: 0 0 100px rgba(0,0,0,0.5);
        }

        /* HEADER */
        .header {
            flex: 0 0 auto; padding: 15px 24px; padding-top: max(15px, env(safe-area-inset-top));
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-bottom: var(--glass-border);
            z-index: 50;
        }
        .header-title {
            font-family: 'Cinzel', serif; font-weight: 700; color: var(--primary-gold);
            letter-spacing: 1.5px; font-size: 1rem; text-transform: capitalize;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        .heart-counter {
            background: rgba(0,0,0,0.3); padding: 8px 14px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1); font-size: 0.95rem; font-weight: 700;
            display: flex; align-items: center; gap: 8px; transition: transform 0.2s;
        }

        /* CHAT AREA */
        #chat-content {
            flex: 1; overflow-y: auto; padding: 20px 16px; padding-bottom: 40px;
            display: flex; flex-direction: column; gap: 16px;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
            mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 100%);
        }
        #chat-content::-webkit-scrollbar { display: none; }

        .dialog-container {
            display: flex; flex-direction: column; max-width: 85%;
            opacity: 0; transform-origin: bottom left;
            animation: elasticPop 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .princess-container { align-self: flex-end; align-items: flex-end; transform-origin: bottom right; }

        @keyframes elasticPop {
            0% { opacity: 0; transform: scale(0.5) translateY(30px); }
            60% { opacity: 1; transform: scale(1.05) translateY(-5px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .dialog-label {
            font-family: 'Cinzel', serif; font-size: 0.7rem; margin-bottom: 4px; 
            font-weight: 600; opacity: 0.8; letter-spacing: 0.5px; margin-left: 10px; text-transform: capitalize;
        }
        .dialog-box {
            padding: 14px 18px; border-radius: 20px; font-size: 1rem; line-height: 1.5;
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: var(--glass-border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative; overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .dialog-box::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.08), transparent);
            pointer-events: none;
        }

        .poet-container .dialog-box { background: var(--poet-bubble); color: #f1f5f9; border-bottom-left-radius: 4px; }
        .princess-container .dialog-box { background: var(--princess-bubble); color: #fff; border-bottom-right-radius: 4px; border: 1px solid rgba(100,255,218,0.3); }

        .narrative {
            align-self: center; text-align: center;
            font-family: 'Urbanist', sans-serif; font-weight: 300; font-size: 0.95rem; letter-spacing: 0.5px;
            color: var(--soft-gold); margin: 12px 0; max-width: 90%;
            padding: 10px 24px;
            background: rgba(255,255,255,0.03); border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            opacity: 0; animation: fadeUp 1s ease forwards;
        }
        @keyframes fadeUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        /* INPUT AREA */
        #input-area {
            flex: 0 0 auto; padding: 20px;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-top: var(--glass-border);
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            display: flex; flex-direction: column; gap: 12px;
            transition: opacity 0.5s ease;
        }

        /* TOMBOL HOVER + CLICK */
        .choice-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
            padding: 16px; border-radius: 18px; color: white;
            font-family: 'Urbanist'; font-weight: 600; text-align: center;
            cursor: pointer; position: relative; overflow: hidden;
            opacity: 0; transform: translateY(20px);
            animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .choice-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,215,0,0.2), transparent);
            transform: skewX(-25deg); transition: 0s;
        }
        .choice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border-color: rgba(255, 215, 0, 0.5);
            background: rgba(255,255,255,0.08);
        }
        .choice-btn:hover::before { left: 150%; transition: 0.6s ease; }
        .choice-btn:active { transform: scale(0.97) translateY(0); background: rgba(255,215,0,0.1); border-color: var(--primary-gold); }
        
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        .input-wrap { display: flex; gap: 10px; width: 100%; animation: slideUp 0.5s forwards; }
        .text-input {
            flex: 1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2);
            padding: 14px 20px; color: white; border-radius: 25px; outline: none; font-size: 1rem;
            transition: 0.3s; font-family: 'Urbanist';
        }
        .text-input:focus { background: rgba(255,255,255,0.15); border-color: var(--primary-gold); box-shadow: 0 0 15px rgba(255,215,0,0.2); }
        .send-btn {
            width: 50px; height: 50px; border-radius: 50%; border:none;
            background: linear-gradient(135deg, var(--primary-gold), #B8860B);
            color: black; font-weight: bold; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 0 20px rgba(255,215,0,0.4);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .send-btn:active { transform: scale(0.9); }

        /* NOTIFICATION */
        #notification {
            position: fixed; top: 12px; left: 50%; transform: translate(-50%, -200%);
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 10px 24px; border-radius: 50px;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            color: white; font-family: 'Urbanist'; font-weight: 600; font-size: 0.9rem;
            z-index: 10001; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: max-content; max-width: 90%;
        }
        .show-notif { transform: translate(-50%, max(5px, env(safe-area-inset-top))) !important; }

        /* IDENTITY OVERLAY */
        #identity-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.5s ease;
        }
        .id-box {
            text-align:center; width:85%; max-width:320px;
            background: rgba(255,255,255,0.06); padding: 35px 25px; border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            transform: scale(0.9); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .id-active .id-box { transform: scale(1); }

        .id-input {
            width: 100%; padding: 18px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.2); color: white; text-align: center; font-size: 1.1rem; outline: none; margin-bottom: 20px; font-family: 'Urbanist';
            transition: 0.3s;
        }
        .id-input:focus { border-color: var(--primary-gold); background: rgba(0,0,0,0.4); }
        .id-input::placeholder { color: rgba(255,255,255,0.5); }
        
        .shake-hard { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 
            10%, 90% { transform: translate3d(-1px, 0, 0); } 
            20%, 80% { transform: translate3d(2px, 0, 0); } 
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 
            40%, 60% { transform: translate3d(4px, 0, 0); } 
        }

        #click-catcher {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 10002;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #666; font-family: 'Urbanist'; letter-spacing: 4px; font-size: 0.8rem;
            cursor: pointer; animation: breathe 3s infinite;
        }
        @keyframes breathe { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }

        /* HEART ANIMATION */
        .flying-heart {
            position: fixed; z-index: 9999; pointer-events: none;
            font-size: 5rem; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            transition: all 1s cubic-bezier(0.2, 0.8, 0.2, 1);
            filter: drop-shadow(0 0 20px rgba(255,0,0,0.5));
        }
        .flying-special { font-size: 8rem !important; filter: drop-shadow(0 0 50px gold) !important; z-index: 10000; }
        .float-score {
            position: fixed; z-index: 9999; font-weight: 800; font-size: 1.2rem;
            pointer-events: none; animation: floatUpFade 1.5s forwards;
            text-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        @keyframes floatUpFade {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(0.9); }
        }
        
        .heart-cracking { display: inline-block; animation: crackShake 0.5s forwards; filter: grayscale(100%) brightness(0.5); }
        @keyframes crackShake { 0% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 50% { transform: rotate(-15deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0deg); } }
        
        .falling-piece { position: fixed; z-index: 9999; font-size: 1.5rem; pointer-events: none; color: #333; animation: gravityFall 1s cubic-bezier(0.5, 0, 1, 1) forwards; }
        @keyframes gravityFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(300px) rotate(180deg); opacity: 0; } }

        /* SOS RED */
        #red-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,0,0,0.6) 0%, transparent 80%); z-index: 9000; pointer-events: none; opacity: 0; transition: opacity 0.1s; mix-blend-mode: overlay; }
        .flash-active { opacity: 1 !important; }
        #sos-layer { position: fixed; top:0; left:0; width:100%; height:100%; opacity:0; pointer-events:none; z-index:50; mix-blend-mode: overlay; }

        #cinematic-text-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 2000; pointer-events: none; opacity: 0; transition: opacity 1.5s ease; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); padding: 30px; }
        .cinematic-msg { font-family: 'Playfair Display', serif; font-size: 2rem; color: #fff; text-align: center; text-shadow: 0 0 30px rgba(255,215,0,0.6); line-height: 1.4; }

        /* UTILS */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020a1a; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .title-cinematic { font-family: 'Cinzel', serif; font-size: 2.5rem; background: linear-gradient(to bottom, #FFD700, #FDB931); -webkit-background-clip: text; background-clip: text; color: transparent; text-align: center; letter-spacing: 2px; text-transform: capitalize; opacity: 0; animation: fadeUp 2s ease forwards 0.5s; }
        .start-btn-cinematic { margin-top: 50px; padding: 15px 45px; background: transparent; border: 1px solid var(--primary-gold); color: var(--primary-gold); font-family: 'Cinzel'; font-weight: 600; letter-spacing: 2px; cursor: pointer; font-size: 0.9rem; opacity: 0; border-radius: 30px; animation: fadeUp 2s ease forwards 1s; transition: 0.3s; }
        
        #result-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #000, #111); z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; opacity: 0; transition: opacity 2s ease; text-align: center; padding: 30px; }
        .score-box { width: 100%; max-width: 380px; margin: 30px 0; background: rgba(255,255,255,0.05); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,215,0,0.15); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .score-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: 'Urbanist'; opacity: 0; transform: translateY(10px); font-size: 1.1rem; }
        .score-row.anim-reveal { animation: elasticPop 0.8s forwards; }
        
        #year-text { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Cinzel', serif; font-size: 3.5rem; color: var(--primary-gold); text-shadow: 0 0 50px rgba(255, 215, 0, 0.8), 0 0 10px white; z-index: 50; opacity: 0; pointer-events: none; letter-spacing: 8px; text-align: center; width: 100%; font-weight: 800; }
        .reveal-year { animation: cinematicZoom 6s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        @keyframes cinematicZoom { 0% { opacity: 0; filter: blur(30px); transform: translate(-50%, -50%) scale(1.5); } 30% { opacity: 1; filter: blur(0px); transform: translate(-50%, -50%) scale(1); } 80% { opacity: 1; filter: blur(0px); transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; filter: blur(20px); transform: translate(-50%, -50%) scale(1.2); } }

        .card-container { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .promise-card { background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.01)); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 16px; width: 100px; height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; opacity: 0; animation: elasticPop 0.8s forwards; backdrop-filter: blur(10px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: 0.3s; }
        .letter-card { background: #fffdf5; color: #1a1a1a; padding: 30px; border-radius: 6px; width: 90%; max-width: 320px; margin: 20px auto; font-family: 'Dancing Script', cursive; font-size: 1.4rem; box-shadow: 0 15px 50px rgba(0,0,0,0.6); transform: rotate(-1deg); opacity: 0; animation: elasticPop 1.5s forwards; }

    </style>
</head>
<body>

    <audio id="uke-song" src="lagu.mp3" preload="auto"></audio>
    <audio id="bgm-song" src="lagu2.mp3" preload="auto" loop></audio>

    <div id="dynamic-bg"></div>

    <canvas id="global-canvas"></canvas> <canvas id="firework-canvas"></canvas> <canvas id="firefly-canvas"></canvas> <canvas id="confetti-canvas"></canvas>
    
    <div id="red-screen"></div>
    <div id="notification"></div>
    <div id="year-text">2026</div>

    <div id="cinematic-text-overlay">
        <div class="cinematic-msg" id="cinematic-msg"></div>
    </div>

    <div id="identity-overlay">
        <div class="id-box">
            <div style="font-family:'Cinzel'; color:var(--primary-gold); font-size:1.3rem; margin-bottom:20px; text-shadow:0 0 10px rgba(0,0,0,0.5);">Verifikasi Identitas</div>
            <input type="text" id="id-input" class="id-input" placeholder="Siapa namamu?" autocomplete="off">
            <button class="choice-btn" style="width:100%; opacity:1; transform:none; background:var(--primary-gold); color:black; font-weight:800; border:none;" onclick="verifyIdentity()">Beri tahu</button>
        </div>
    </div>

    <div id="click-catcher" onclick="initAudioAndIntro()">
        <span style="font-size: 2rem; margin-bottom: 15px;">‚úß</span>
        <span style="font-weight: 600; letter-spacing:4px;">TAP TO START</span>
    </div>

    <div id="result-screen" style="display: none;">
        <h1 style="font-family:'Cinzel'; color:var(--primary-gold); font-size:2.5rem; margin-bottom:10px; text-shadow: 0 0 30px var(--primary-gold); text-transform: capitalize;">The End</h1>
        
        <div class="score-box">
            <div class="score-row" id="row-red">
                <span>Hearts Collected</span>
                <span id="val-red" style="font-weight:bold;">0</span>
            </div>
            <div class="score-row" id="row-white">
                <span>White Heart (SOS)</span>
                <span id="val-white" style="font-weight:bold;">...</span>
            </div>
            <div class="score-row" id="row-gold">
                <span>Golden Heart</span>
                <span id="val-gold" style="font-weight:bold;">...</span>
            </div>
            <div class="score-row" id="row-total" style="border:none; margin-top:15px; color:var(--primary-gold); font-weight:800;">
                <span>TOTAL SCORE</span>
                <span id="val-total">0 / 10</span>
            </div>
        </div>

        <p id="result-msg" style="font-family:'Urbanist'; font-size:1.1rem; max-width:85%; line-height:1.6; margin-bottom:40px; color:#ccc;"></p>
        <button onclick="location.reload()" class="choice-btn" style="opacity:1; transform:none; border-color:var(--primary-gold); color:var(--primary-gold);">Ulangi Kisah</button>
    </div>

    <div id="start-overlay">
        <h1 class="title-cinematic">The Poet &<br>The Princess</h1>
        <button class="start-btn-cinematic" onclick="enterGame()">Buka Cerita</button>
    </div>

    <div id="mobile-frame">
        <div class="header">
            <span class="header-title">The Poet</span>
            <div class="heart-counter">
                <span id="heart-icon" style="transition:0.3s; display:inline-block;">‚ù§Ô∏è</span> 
                <span id="heart-count" style="margin-left: 5px;">0</span> <span id="inventory" style="margin-left:5px"></span>
            </div>
        </div>

        <div id="sos-layer"></div>
        <div id="chat-content"></div>
        <div id="input-area"></div>
    </div>

<script>
    // --- AUDIO SYSTEM ---
    const AudioSys = {
        ctx: null, masterGain: null,
        init: function() {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            this.masterGain = this.ctx.createGain();
            this.masterGain.gain.value = 0.6; 
            this.masterGain.connect(this.ctx.destination);
        },
        createOsc: function(type, freq, t, dur, vol = 0.1) {
            const o = this.ctx.createOscillator(); o.type = type; o.frequency.setValueAtTime(freq, t);
            const g = this.ctx.createGain(); 
            g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(vol, t + 0.02); g.gain.exponentialRampToValueAtTime(0.001, t + dur);
            o.connect(g); g.connect(this.masterGain);
            o.start(t); o.stop(t + dur + 0.1);
        },
        play: function(key) {
            if(!this.ctx) return;
            const t = this.ctx.currentTime;
            if(key === 'intro') { 
                [261.63, 329.63, 392.00, 523.25].forEach((f,i) => { 
                    const o = this.ctx.createOscillator(); o.type = 'sine'; o.frequency.value = f;
                    const g = this.ctx.createGain();
                    g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.2, t+2); g.gain.exponentialRampToValueAtTime(0.001, t+6);
                    o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+6);
                });
            }
            else if(key === 'type') { this.createOsc('triangle', 600 + (Math.random() * 200), t, 0.05, 0.05); } 
            else if(key === 'sent') { 
                const o = this.ctx.createOscillator(); o.frequency.setValueAtTime(400, t); o.frequency.exponentialRampToValueAtTime(800, t+0.1);
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.1);
                o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+0.1);
            }
            else if(key === 'heaven') { [523, 659, 783, 1046, 1318].forEach((f,i) => setTimeout(() => this.createOsc('sine', f, t+i*0.05, 2.0, 0.1), i*50)); }
            else if(key === 'levelup') { this.createOsc('sine', 523.25, t, 0.3, 0.1); setTimeout(() => this.createOsc('sine', 783.99, t+0.1, 0.3, 0.1), 100); }
            else if(key === 'break') { this.createOsc('sawtooth', 100, t, 0.3, 0.15); }
            else if(key === 'error') { this.createOsc('square', 150, t, 0.2, 0.1); }
            // SYSTEM NOTIFICATION SOUND
            else if(key === 'system') {
                const o = this.ctx.createOscillator(); o.type = 'sine'; o.frequency.setValueAtTime(800, t); o.frequency.linearRampToValueAtTime(1200, t+0.1);
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.4);
                o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+0.4);
            }
            else if(key === 'siren') { 
                const o = this.ctx.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(600, t); o.frequency.linearRampToValueAtTime(800, t+0.4); o.frequency.linearRampToValueAtTime(600, t+0.8);
                const g = this.ctx.createGain(); g.gain.value=0.1; o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+2);
            }
            // FIREWORK TRAIL
            else if(key === 'trail') {
                const o = this.ctx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(200, t); o.frequency.linearRampToValueAtTime(600, t+1.2);
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0, t+1.2);
                o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t+1.3);
            }
            // FIREWORK EXPLOSION
            else if(key === 'firework') {
                const bs = this.ctx.sampleRate * 0.5; const buf = this.ctx.createBuffer(1, bs, this.ctx.sampleRate);
                const d = buf.getChannelData(0); for(let i=0; i<bs; i++) d[i] = (Math.random()*2-1) * Math.exp(-5*i/this.ctx.sampleRate);
                const src = this.ctx.createBufferSource(); src.buffer = buf;
                const f = this.ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 500;
                const g = this.ctx.createGain(); g.gain.value = 0.5;
                src.connect(f); f.connect(g); g.connect(this.masterGain); src.start(t);
            }
        }
    };

    // --- UI REFERENCES ---
    const UI = {
        chat: document.getElementById('chat-content'),
        input: document.getElementById('input-area'),
        hearts: document.getElementById('heart-count'),
        heartIcon: document.getElementById('heart-icon'),
        inv: document.getElementById('inventory'),
        sos: document.getElementById('sos-layer'),
        frame: document.getElementById('mobile-frame'),
        notif: document.getElementById('notification'),
        redScreen: document.getElementById('red-screen'),
        yearText: document.getElementById('year-text'),
        bgCanvas: document.getElementById('global-canvas'),
        fwCanvas: document.getElementById('firework-canvas'),
        ffCanvas: document.getElementById('firefly-canvas'),
        result: document.getElementById('result-screen'),
        cinematicOverlay: document.getElementById('cinematic-text-overlay'),
        cinematicMsg: document.getElementById('cinematic-msg'),
        idOverlay: document.getElementById('identity-overlay'),
        idInput: document.getElementById('id-input'),
        idBox: document.querySelector('.id-box'),
        bgDynamic: document.getElementById('dynamic-bg'),
        rRed: document.getElementById('val-red'),
        rWhite: document.getElementById('val-white'),
        rGold: document.getElementById('val-gold'),
        rTotal: document.getElementById('val-total'),
    };
    
    let state = { hearts: 0, gold: false, white: false };
    let isSnowing = false, isFireworks = false, isFireflies = false;
    let fwSoundCount = 0; // AUDIO COUNTER

    // --- UTILS ---
    function scrollDown() { setTimeout(() => { UI.chat.scrollTo({ top: UI.chat.scrollHeight, behavior: 'smooth' }); }, 100); }

    function initAudioAndIntro() {
        document.getElementById('click-catcher').style.display = 'none';
        AudioSys.init();
        AudioSys.play('intro');
        document.querySelector('.title-cinematic').style.opacity = 1; 
        document.querySelector('.start-btn-cinematic').style.opacity = 1;
        document.getElementById('start-overlay').style.display = 'flex';
        initAmbientDust(); 
    }

    function enterGame() {
        AudioSys.play('levelup');
        const overlay = document.getElementById('start-overlay');
        overlay.style.transition = "opacity 1.5s ease";
        overlay.style.opacity = 0;
        setTimeout(() => { overlay.style.display = 'none'; runScript(); }, 1500);
    }

    function poetChat(text, speed = 40) {
        return new Promise(resolve => {
            UI.input.innerHTML = ''; 
            const div = document.createElement('div');
            div.className = 'dialog-container poet-container';
            div.innerHTML = `<div class="dialog-label">Penyair</div><div class="dialog-box"></div>`;
            UI.chat.appendChild(div);
            const box = div.querySelector('.dialog-box');
            let i = 0; scrollDown();
            const int = setInterval(() => {
                box.textContent += text.charAt(i);
                if(i % 2 === 0) AudioSys.play('type');
                scrollDown(); i++;
                if(i>=text.length) { clearInterval(int); setTimeout(resolve, 600 + text.length*10); } 
            }, speed);
        });
    }

    function princessChat(text) {
        const div = document.createElement('div');
        div.className = 'dialog-container princess-container';
        div.innerHTML = `<div class="dialog-label">Tuan Putri</div><div class="dialog-box">${text}</div>`;
        UI.chat.appendChild(div);
        AudioSys.play('sent'); scrollDown();
    }

    function addNarrative(text) {
        return new Promise(resolve => {
            const div = document.createElement('div');
            div.className = 'narrative';
            div.innerHTML = text;
            UI.chat.appendChild(div);
            scrollDown(); setTimeout(resolve, 2000);
        });
    }

    function showInput(ph, cb) {
        UI.input.innerHTML = `<div class="input-wrap"><input type="text" id="userInput" class="text-input" placeholder="${ph}" autocomplete="off"><button class="send-btn" onclick="subIn()">‚û§</button></div>`;
        const el = document.getElementById('userInput'); el.focus(); scrollDown();
        el.addEventListener("keypress", function(event) { if (event.key === "Enter") window.subIn(); });
        window.subIn = function() { if(el.value.trim() === "") return; cb(el.value, el); }
    }

    function showOptions(opts) {
        UI.input.innerHTML = '';
        opts.forEach((o,i) => {
            const btn = document.createElement('div');
            btn.className = 'choice-btn';
            btn.innerText = o.text;
            btn.style.animationDelay = `${i*0.1}s`;
            btn.onclick = () => { 
                AudioSys.play('type'); 
                btn.style.transform = "scale(0.9)";
                setTimeout(() => { UI.input.innerHTML=''; o.action(); }, 150);
            };
            UI.input.appendChild(btn);
        });
        scrollDown();
    }

    // --- HEART MECHANICS ---
    function updateHearts(val, isGold = false) {
        const targetRect = UI.heartIcon.getBoundingClientRect();
        const targetX = targetRect.left + targetRect.width/2;
        const targetY = targetRect.top + targetRect.height/2;

        if (isGold) {
            state.hearts += val;
            UI.hearts.innerText = state.hearts;
            state.gold = true;
            AudioSys.play('heaven');
            UI.inv.innerHTML += "üíõ";
            
            const fly = document.createElement('div');
            fly.className = 'flying-heart flying-special';
            fly.innerText = 'üíõ';
            document.body.appendChild(fly);
            
            requestAnimationFrame(() => { fly.style.transform = "translate(-50%, -50%) scale(1)"; fly.style.opacity = 1; });
            setTimeout(() => { fly.style.left = targetX + 'px'; fly.style.top = targetY + 'px'; fly.style.transform = "translate(-50%, -50%) scale(0.1)"; fly.style.opacity = 0; }, 1500);
            setTimeout(() => fly.remove(), 2500);
            return;
        }

        if (val > 0) {
            const fly = document.createElement('div');
            fly.className = 'flying-heart';
            fly.innerText = '‚ù§Ô∏è';
            document.body.appendChild(fly);

            requestAnimationFrame(() => { fly.style.transform = "translate(-50%, -50%) scale(1.5)"; fly.style.opacity = 1; });
            setTimeout(() => { fly.style.left = targetX + 'px'; fly.style.top = targetY + 'px'; fly.style.transform = "translate(-50%, -50%) scale(0.2)"; fly.style.opacity = 0; }, 800);
            setTimeout(() => {
                fly.remove(); state.hearts += val; UI.hearts.innerText = state.hearts;
                AudioSys.play('levelup'); UI.heartIcon.classList.add('heart-pump');
                
                const float = document.createElement('div'); float.className = 'float-score'; float.innerText = "+1 ‚ù§Ô∏è"; float.style.color = "#4cd964";
                float.style.left = targetX + 'px'; float.style.top = (targetY + 30) + 'px';
                document.body.appendChild(float); setTimeout(()=>float.remove(), 1500);
                setTimeout(()=>UI.heartIcon.classList.remove('heart-pump'), 400);
            }, 1600);
        } else {
            AudioSys.play('break');
            UI.heartIcon.innerHTML = "üíî"; UI.heartIcon.classList.add('heart-cracking');
            
            const fall = document.createElement('div'); fall.className = 'falling-piece'; fall.innerText = "üíî";
            fall.style.left = targetX + 'px'; fall.style.top = targetY + 'px';
            document.body.appendChild(fall);

            setTimeout(() => {
                state.hearts += val; UI.hearts.innerText = state.hearts; UI.heartIcon.classList.remove('heart-cracking'); UI.heartIcon.innerHTML = "‚ù§Ô∏è";
                const float = document.createElement('div'); float.className = 'float-score'; float.innerText = "-1 üíî"; float.style.color = "#ff3b30";
                float.style.left = targetX + 'px'; float.style.top = (targetY + 30) + 'px';
                document.body.appendChild(float); setTimeout(()=>float.remove(), 1500);
                fall.remove();
            }, 1000);
        }
    }

    function notifMsg(txt, type) {
        UI.notif.innerHTML = txt;
        if(type === 'gold') { UI.notif.style.border = "1px solid var(--primary-gold)"; UI.notif.style.color="var(--primary-gold)"; }
        else if(type === 'white') { UI.notif.style.border = "1px solid white"; UI.notif.style.color="white"; }
        else { UI.notif.style.border = "1px solid rgba(255,255,255,0.15)"; UI.notif.style.color="white"; }
        
        UI.notif.classList.add('show-notif');
        setTimeout(() => UI.notif.classList.remove('show-notif'), 4000);
    }

    // --- SCRIPT STORY ---
    async function runScript() {
        await new Promise(r=>setTimeout(r,1000));
        await addNarrative("Kamu berjalan di tengah taman...");
        await addNarrative("Kamu menemukan ukulele di kursi taman.");
        showOptions([{ text: "[Ambil] ‚úã", action: sceneUkulele }, { text: "[Percayakan keputusan pada hatimu] ‚ú®", action: sceneUkulele }]);
    }

    async function sceneUkulele() {
        await addNarrative("Kamu mengambil Ukulele.");
        await addNarrative("Jreng Jreng Jreng... (Petikan Ukulelemu sangat buruk)");
        await poetChat("WEH, Ukulele gw!");
        await poetChat("Kalo mau nyuri seengganya bisa mainin!");
        await poetChat("Bentar... kamu kayak ga asing.");
        await poetChat("Siapa kamu?");
        askName();
    }

    function askName() {
        UI.idOverlay.style.display = 'flex';
        setTimeout(() => { UI.idOverlay.style.opacity = 1; UI.idOverlay.classList.add('id-active'); }, 50);
        document.getElementById('id-input').focus();
    }

    function verifyIdentity() {
        const val = document.getElementById('id-input').value.toLowerCase();
        const keys = ['aksa', 'cila', 'cilla', 'priscilla', 'tante', 'ayang', 'sayang', 'pacar', 'kaka', 'kakak', 'kak', 'nanda', 'putri', 'tuan'];
        
        if(keys.some(k=>val.includes(k))) {
            AudioSys.play('levelup');
            UI.idOverlay.style.opacity = 0; UI.idOverlay.classList.remove('id-active');
            setTimeout(() => { UI.idOverlay.style.display = 'none'; proceed(); }, 500);
        } else {
            AudioSys.play('error');
            // SHAKE EFFECT FIX
            const box = document.querySelector('.id-box');
            box.classList.remove('shake-hard');
            void box.offsetWidth; 
            box.classList.add('shake-hard');
            
            // Red Flash
            UI.redScreen.classList.add('flash-active');
            setTimeout(()=> UI.redScreen.classList.remove('flash-active'), 200);

            // Error Text
            const input = document.getElementById('id-input');
            input.value = '';
            input.placeholder = "Oh, aku salah orang...";
            input.style.borderColor = "red";
            setTimeout(() => input.style.borderColor = "rgba(255,255,255,0.2)", 1500);
        }
    }

    async function proceed() {
        await poetChat("Eh kirain siapa, ternyata Tuan Putri");
        
        AudioSys.play('system');
        notifMsg("‚ù§Ô∏è SYSTEM HEART: ACTIVATED", "normal");
        
        await new Promise(r=>setTimeout(r, 2000));
        
        updateHearts(1);
        await poetChat("Lama ga ketemu yaa");
        await poetChat("Udah deket penghujung tahun ya, gak kerasa.");
        await poetChat("Btw...");
        await poetChat("Sini Ukulelenya gw mainin, mau denger gaa?");
        showOptions([{ text: "Wih sok banget, emang bisa? Wkwk coba deh üòè", action: ()=>q1('A') }, { text: "Gausah, nanti u malu maluin üôÑ", action: ()=>q1('B') }]);
    }

    async function q1(c) {
        UI.input.innerHTML = '';
        const s1 = document.getElementById('uke-song');
        const s2 = document.getElementById('bgm-song');

        if(c=='A') { 
            princessChat("Widih sok banget, emang bisa? Wkwk coba deh üòè"); 
            updateHearts(1); 
            await poetChat("Yee ngeremehin üòé");
            await poetChat("Ehem ehem... üé§üé∏");
            if(s1) { s1.currentTime = 0; s1.play().catch(e=>{}); }
            await new Promise(r => setTimeout(r, 5000));
            q2();
        } else { 
            princessChat("Gausah, nanti malu maluin üôÑ"); 
            updateHearts(-1); 
            await poetChat("Yaudaa yaudaaa engga gw mainin"); 
            if(s2) { s2.currentTime = 0; s2.play().catch(e=>{}); }
            q2();
        }
    }

    async function q2() {
        await poetChat("Inget gak dulu u pernah pamerin mainin lagu Blue - Yung kai pake ukulele estetik u itu?");
        showOptions([{ text: "HAHAHA si anj, inget aja loh üòÇ", action: ()=>q2r('A') }, { text: "Emang iya ya? i ga inget ah ü§î", action: ()=>q2r('B') }, { text: "Inget dongg, sekeren itu kan i sampe u ingett HAHAHA üòé", action: ()=>q2r('C') }]);
    }

    async function q2r(c) {
        if(c=='A') { princessChat("HAHAHA si anj, inget aja loh üòÇ"); updateHearts(1); await poetChat("Siapa si yang ga inget malem-malem u gabisa tidur terus pamer skill yang u bangga-banggakan itu"); }
        else if(c=='B') { princessChat("Emang iya ya? i ga inget ah ü§î"); updateHearts(-1); await poetChat("Yeuu kocak"); }
        else { princessChat("Inget dongg, sekeren itu kan i sampe u ingett HAHAHA üòé"); updateHearts(2); await poetChat("woiyaaa jelas dong, gw selalu bangga punya u waktu itu wkwk"); }
        q3();
    }

    async function q3() {
        await poetChat("Masih sering latihan mainin gak?");
        showOptions([{ text: "Aduh dimana yak Ukulele i, udah ketimbun debu kayanya üíÄ", action: ()=>q3r('A') }, { text: "MASIH DONG! i bisa mainin banyak lagu sekarang üé∏", action: ()=>q3r('B') }, { text: "Kalo gabut doang i mainin üò∂", action: ()=>q3r('C') }]);
    }

    async function q3r(c) {
        if(c=='A') { princessChat("Aduh dimana yak Ukulele i, udah ketimbun debu kayanya üíÄ"); updateHearts(-2); await poetChat("BERSIHIN KAMAR GAK U SEKARANG! üî™"); await poetChat("Masih sering berantakan kayak waktu itu pasti, baju numpuk dimana-mana"); }
        else if(c=='B') { princessChat("MASIH DONG! i bisa mainin banyak lagu sekarang üé∏"); updateHearts(2); await poetChat("Makin bangga aja lagi gw sama u"); }
        else { princessChat("Kalo gabut doang i mainin üò∂"); updateHearts(1); await poetChat("Yaudalaa, seengganya gabutnya ga buka live tiktok Batik Christo lagi"); }
        q4();
    }

    async function q4() {
        await poetChat("Jadi... gimana sama yang sekarang?");
        showOptions([{ text: "Puji Tuhan, Alhamdulillah yaa aman terkendali. üòá", action: ()=>q4r('A') }, { text: "Udah engga lanjut nih üòÆ‚Äçüí®", action: ()=>q4r('B') }, { text: "i butuh u. üÜò", action: ()=>q4r('C') }]);
    }

    async function q4r(c) {
        if(c=='A') { 
            princessChat("Puji Tuhan, Alhamdulillah yaa aman terkendali. üòá"); 
            updateHearts(1); 
            await poetChat("Alhamdulillah, puji tuhan, semoga langgeng, lancar semua dan selalu baik-baik aja yaa, gw ikut seneng u sama dia"); 
            nextFinal(); 
        }
        else if(c=='B') { 
            princessChat("Udah engga lanjut nih üòÆ‚Äçüí®"); 
            updateHearts(1); 
            await poetChat("Tu kan mending sama gw anjir, wkwk"); 
            await poetChat("Tapi ya, semoga u bisa tau ya apa yang u butuh sebenernya, karena apa yang paling u mau terkadang bukan yang sebenernya paling u butuhin"); 
            nextFinal(); 
        }
        else {
            princessChat("i butuh u. üÜò"); await poetChat("jawab yang bener");
            showOptions([{ text: "Iya i serius loh ü•∫", action: sosTrigger }, { text: "hehe maaf cuman iseng jawab gitu üòú", action: ()=>{ princessChat("hehe maaf.."); q4(); } }]);
        }
    }

    async function sosTrigger() {
        princessChat("Iya i serius loh ü•∫"); 
        AudioSys.play('siren');
        state.white = true; 
        updateHearts(1); 
        UI.inv.innerHTML += "ü§ç"; 
        
        // Visual SOS
        UI.sos.style.animation = "sosFlash 0.5s 3"; 
        notifMsg("üîî SYSTEM INFO: Contacting Poet...", "white");
        
        await poetChat("RED CODE!! üö® Meluncurkan rudal pelukan dan ciuman sekarang juga! Bertahan di sana prajurit, bantuan datang!");
        showOptions([ { text: "Chat Sekarang üí¨", action: chatWhatsApp }, { text: "Nanti Aja Deh üçÇ", action: () => { princessChat("Nanti Aja Deh üçÇ"); poetChat("Okee simpen dulu aja").then(nextFinal); } } ]);
    }

    function chatWhatsApp() {
        let myNumber = "62895328424441"; 
        let msg = "*S.O.S* _Cila butuh adick Aksa";
        window.open(`https://wa.me/${myNumber}?text=${encodeURIComponent(msg)}`, '_blank');
        princessChat("Chat Sekarang üí¨");
        poetChat("Ditunggu notifnya ya...").then(nextFinal);
    }

    async function nextFinal() {
        await poetChat("Gw keasikan ngobrol sampe lupa nanya, gimana kabar u...?"); await poetChat("Tuan Putri.. Cila?");
        showOptions([{ text: "Puji Tuhan, Alhamdulillah, semua aman-aman aza ko, BEST! ‚ú®", action: ()=>fin('A') }, { text: "Ya gitu-gitu ajaa sii üòê", action: ()=>fin('B') }, { text: "Puji Tuhan baik semuaa, tapi kangen adik penyair i ü•∫üíõ", action: ()=>fin('C') }]);
    }

    async function fin(c) {
        if(c=='A') { princessChat("Puji Tuhan, Alhamdulillah, semua aman-aman aza ko, BEST! ‚ú®"); updateHearts(1); }
        else if(c=='B') { princessChat("Ya gitu-gitu ajaa sii üòê"); updateHearts(-2); await poetChat("Niatan dikit kek jawabnyaa, yee kocak"); }
        else { 
            princessChat("Puji Tuhan baik semuaa, tapi kangen adik penyair i ü•∫üíõ"); 
            updateHearts(1, true); 
            await addNarrative("Achievement: Happily Never After");
        }
        phaseChristmas();
    }

    async function phaseChristmas() {
        await new Promise(r=>setTimeout(r, 1000));
        
        UI.chat.style.opacity = 0;
        await new Promise(r=>setTimeout(r, 1000));
        UI.chat.innerHTML = '';
        UI.chat.style.opacity = 1;

        await poetChat("Kayanya, salju mulai turun...");
        
        const s2 = document.getElementById('bgm-song');
        if(s2 && s2.paused) s2.play().catch(e=>{});

        await new Promise(r=>setTimeout(r, 1000));

        isSnowing = true;
        
        await poetChat("Loh... bukannya kita ada di indonesia yak ü§®"); 
        await new Promise(r=>setTimeout(r, 1000));

        const m = [
            "Oh iyaa, Selamat Natal yaa..",
            "Jujur, u berarti banget buat gw sebagai apapun",
            "Bahkan sama u terakhir kali gw ngerasain punya kakak yang sesayang itu sama gw, punya seseorang yang sepeduli itu...",
            "Tahun baru nanti, dan tahun-tahun berikutnya..",
            "Gw selalu doain yang terbaik buat u",
            "Selamat Natal..."
        ];
        for(let t of m) { await poetChat(t, 55); await new Promise(r=>setTimeout(r, 1500)); }

        triggerNewYearScene();
    }

    // --- PHASE: NEW YEAR ---
    async function triggerNewYearScene() {
        await new Promise(r=>setTimeout(r, 2000));
        UI.chat.style.transition = "opacity 2s";
        UI.chat.style.opacity = 0; 
        
        isSnowing = false; 

        await new Promise(r=>setTimeout(r, 1000));
        
        const yTxt = UI.yearText;
        
        // REVISI LOGIC:
        // 1. Muncul teks 2026 -> Launch Center FW -> Change Background
        yTxt.classList.add('reveal-year'); 
        
        // Ubah Background ke Ungu
        UI.bgDynamic.classList.add('phase-royal');
        
        // Kembang Api Utama
        isFireworks = true;
        UI.fwCanvas.style.opacity = 1;
        window.launchCenterFirework();
            
        setTimeout(() => {
            yTxt.classList.remove('reveal-year');
            yTxt.innerText = "Selamat Tahun Baru!";
            yTxt.classList.add('reveal-year');
        }, 1500); // Sesuaikan dengan ledakan pertama

        await new Promise(r=>setTimeout(r, 7000)); 
        UI.chat.innerHTML = '';
        UI.chat.style.opacity = 1;
        
        await poetChat("Selamat udah namatin level 2025 dengan keren!", 60);
        await new Promise(r=>setTimeout(r, 1000));
        await poetChat("Bener-bener ga kerasa yaa.", 60);
        await poetChat("Makasih buat tahun kemaren, buat semua kenangan jadi partner in crimenya.", 60);
        await poetChat("Kalo mau nyari partner in crime lagi, inget u selalu punya adik keren ini yaa.", 60);

        runPhaseWish();
    }

    async function runPhaseWish() {
        await poetChat("Tahun ini apa yang mau u capai?", 60);
        await poetChat("Mau naklukin apa lagi?", 60);
        await poetChat("Kasih tau yaa, bakal kasih Aaamiin paling serius gw", 60);
        await poetChat("dua agama kurang powerful apa tu, wkwk", 60);
        
        showInput("Tulis harapanmu...", (val) => {
            princessChat(val); 
            UI.input.innerHTML = '';
            runPhaseLetter(val);
        });
    }

    async function runPhaseLetter(wishText) {
        await new Promise(r=>setTimeout(r, 1000));
        
        const letter = document.createElement('div');
        letter.className = 'letter-card';
        letter.innerHTML = `
            <div style="border-bottom:1px solid #ddd; margin-bottom:15px; padding-bottom:5px; font-size:1rem; opacity:0.6;">Dear God,</div>
            <div style="margin-bottom:20px; font-size:1.4rem; line-height:1.4;">"${wishText}"</div>
            <div style="text-align:right; font-size:1rem; margin-top:10px;">Priscilla A.T.</div>
        `;
        UI.chat.appendChild(letter);
        scrollDown();
        AudioSys.play('heaven');

        await new Promise(r=>setTimeout(r, 3000));
        
        const cOverlay = UI.cinematicOverlay;
        const cMsg = UI.cinematicMsg;
        cMsg.innerText = "Semoga doa yang u harapkan tercapai, apapun itu";
        cOverlay.style.opacity = 1;

        await new Promise(r=>setTimeout(r, 4000));
        cOverlay.style.opacity = 0; 
        
        if(state.gold) goldenPromise(); else finalTransition();
    }

    function goldenPromise() {
        setTimeout(() => {
            isFireworks = false;
            UI.fwCanvas.style.opacity = 0;
            UI.chat.innerHTML = ""; 
            isFireflies = true;
            UI.ffCanvas.style.opacity = 1;

            const title = document.createElement('div');
            title.innerHTML = "<h2 style='font-family:Cinzel; color:#FFD700; text-align:center; text-shadow:0 0 20px #FFD700'>Chapter : The Golden Promise</h2>"; 
            UI.chat.appendChild(title);
            
            const sub = document.createElement('div');
            sub.innerHTML = "<p style='text-align:center; color:#ddd; font-size:0.9rem; margin:15px'>Karena telah mendapatkan Golden Heart, u bisa memilih di kehidupan selanjutnya, ingin reinkarnasi jadi apa?</p>";
            UI.chat.appendChild(sub);
            
            const container = document.createElement('div');
            container.className = 'card-container';
            const cards = [
                { id: 'pasangan', icon: 'üíç', label: 'Pasangan' },
                { id: 'kakak', icon: 'üõ°Ô∏è', label: 'Kakak' },
                { id: 'bestie', icon: 'ü§û', label: 'Bestie' }
            ];
            cards.forEach(c => {
                const card = document.createElement('div');
                card.className = 'promise-card';
                card.innerHTML = `<div style="font-size:2.5rem; margin-bottom:5px">${c.icon}</div><div style="font-size:0.8rem; text-transform:uppercase">${c.label}</div>`;
                card.onclick = () => melancholy(c.id);
                container.appendChild(card);
            });
            UI.chat.appendChild(container);
            scrollDown();
        }, 2000);
    }

    async function melancholy(choice) {
        UI.chat.innerHTML = ''; 
        let reply = "";
        if(choice === 'pasangan') reply = "Semoga kita terikat di kehidupan selanjutnya sebagai pasangan paling hangat sedunia. Btw, lucu juga yaa bakal gimana \"Ketidaksengajaan\" yang pertemuin kita nanti";
        if(choice === 'kakak') reply = "Semoga yaa, tapi u jangan galak-galak sama adick u inii, nanti kita pasti jadi duo troublemaker wkwk";
        if(choice === 'bestie') reply = "Lucu juga ya, entah bakal jadi partner in crime macam apa kitaa";
        
        await poetChat(reply, 60); 
        await new Promise(r=>setTimeout(r, 2000));
        
        const finalDiv = document.createElement('div');
        finalDiv.style.cssText = "text-align:center; margin-top:40px; font-family:Cinzel; font-size:1.1rem; color:#fff; text-shadow:0 0 10px gold; opacity:0; transition:opacity 2s";
        finalDiv.innerText = "Apapun itu gw janji bakal sayangin u, bahkan kalo dikehidupan selanjutnya mungkin u jadi cacing";
        UI.chat.appendChild(finalDiv); scrollDown();
        setTimeout(() => finalDiv.style.opacity = '1', 100);

        await new Promise(r=>setTimeout(r, 5000));
        finalTransition();
    }

    function finalTransition() {
        UI.frame.style.opacity = 0; 
        AudioSys.play('firework'); 
        AudioSys.play('confetti'); 
        startConfetti();

        setTimeout(() => {
            UI.result.style.display = 'flex'; 
            setTimeout(() => UI.result.style.opacity = 1, 100);
            animateResult();
        }, 1500);
    }

    function animateResult() {
        let redScore = state.hearts; 
        let displayRed = redScore - (state.white?1:0) - (state.gold?1:0); 
        let totalScore = redScore;

        setTimeout(() => { document.getElementById('row-red').classList.add('anim-reveal'); countUp(UI.rRed, displayRed); }, 500);
        setTimeout(() => { 
            document.getElementById('row-white').classList.add('anim-reveal'); 
            if(state.white) { document.getElementById('val-white').innerHTML = "<span style='color:white'>FOUND (+1)</span>"; AudioSys.play('levelup'); }
            else { document.getElementById('val-white').innerHTML = "<span style='color:#555'>MISSING</span>"; AudioSys.play('error'); }
        }, 1500);
        setTimeout(() => { 
            document.getElementById('row-gold').classList.add('anim-reveal'); 
            if(state.gold) { document.getElementById('val-gold').innerHTML = "<span style='color:gold'>FOUND (+1)</span>"; AudioSys.play('heaven'); }
            else { document.getElementById('val-gold').innerHTML = "<span style='color:#555'>MISSING</span>"; AudioSys.play('error'); }
        }, 2500);
        setTimeout(() => {
            document.getElementById('row-total').classList.add('anim-reveal');
            document.getElementById('val-total').innerText = totalScore + " / 10";
            AudioSys.play('intro');
            
            let msg = "";
            if (totalScore < 4) msg="Apaanjir segitu doang kocak.";
            else if (totalScore < 8) msg="Ya lumayan lah, tetep aja kocak cuman dapet segitu.";
            else if (totalScore >= 8 && !state.gold) msg="Wih dapet banyak, emang BEST!";
            else if (state.gold && totalScore >= 9) msg="KEREEEEEEN BISA DAPETIN SEMUA, emang BEST sangat kakak kesayangan gw.";
            else msg = "Wih dapet Golden Heart! Hampir sempurna.";
            document.getElementById('result-msg').innerText = msg;
        }, 3500);
    }

    function countUp(el, max) {
        let curr = 0; if(max <= 0) { el.innerText = 0; return; }
        let int = setInterval(() => { curr++; el.innerText = curr; if(curr >= max) clearInterval(int); }, 80);
    }

    // --- VISUAL ENGINE (CANVAS) ---
    function setupCanvas(c) { c.width = window.innerWidth; c.height = window.innerHeight; return c.getContext('2d'); }

    function initAmbientDust() {
        const ctx = setupCanvas(UI.bgCanvas);
        const particles = Array(80).fill().map(() => ({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, size: Math.random()*2, speed: Math.random()*0.5 + 0.1, opacity: Math.random() }));
        const snow = Array(50).fill().map(() => ({ x: Math.random()*window.innerWidth, y: Math.random()*-window.innerHeight, s: Math.random()*3+2, v: Math.random()*1+0.5 }));

        function loop() {
            ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
            // DUST
            particles.forEach(p => {
                ctx.fillStyle = `rgba(255, 215, 0, ${p.opacity})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                p.y -= p.speed; if(p.y < 0) p.y = window.innerHeight;
            });
            // SNOW
            if(isSnowing) {
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                snow.forEach(f => {
                    ctx.beginPath(); ctx.arc(f.x, f.y, f.s, 0, Math.PI*2); ctx.fill();
                    f.y += f.v; f.x += Math.sin(f.y/50)*0.5;
                    if(f.y > window.innerHeight) { f.y = -10; f.x = Math.random()*window.innerWidth; }
                });
            }
            requestAnimationFrame(loop);
        } loop();
    }

    function initFireworks() {
        const ctx = setupCanvas(UI.fwCanvas);
        let particles = [];
        window.launchCenterFirework = () => { 
            createExplosion(window.innerWidth/2, window.innerHeight/2); 
            AudioSys.play('trail'); // SUARA TRAIL PERTAMA
            setTimeout(() => { 
                AudioSys.play('firework'); // SUARA LEDAKAN PERTAMA
                fwSoundCount = 1; // MULAI HITUNGAN SUARA
            }, 800);
        };
        
        function createExplosion(x,y) {
            const colors = ['#ff0', '#0ff', '#f0f', '#fff', '#FFA500'];
            for(let i=0; i<60; i++) {
                const angle = Math.PI*2*i/60; const speed = Math.random()*5+2;
                particles.push({x, y, vx:Math.cos(angle)*speed, vy:Math.sin(angle)*speed, color:colors[Math.floor(Math.random()*colors.length)], alpha:1});
            }
        }
        function loop() {
            if(isFireworks || particles.length > 0) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
                ctx.globalCompositeOperation = 'lighter';
                particles.forEach((p,i) => {
                    ctx.fillStyle = p.color; ctx.globalAlpha = p.alpha;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                    p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.alpha -= 0.015;
                    if(p.alpha <= 0) particles.splice(i,1);
                });
                
                // LOGIKA AUDIO: HANYA 4 PERTAMA (1 Center + 3 Random)
                if(isFireworks && Math.random() < 0.03) { 
                    createExplosion(Math.random()*window.innerWidth, Math.random()*window.innerHeight*0.6); 
                    if (fwSoundCount > 0 && fwSoundCount < 4) {
                        AudioSys.play('firework');
                        fwSoundCount++;
                    }
                }
            } else { ctx.clearRect(0,0,window.innerWidth,window.innerHeight); }
            requestAnimationFrame(loop);
        } loop();
    }

    function initFireflies() {
        const ctx = setupCanvas(UI.ffCanvas);
        const flies = Array(30).fill().map(() => ({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, s: Math.random()*3, a: Math.random(), da: 0.02 }));
        function loop() {
            ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
            if(isFireflies) {
                flies.forEach(f => {
                    ctx.beginPath(); ctx.arc(f.x, f.y, f.s, 0, Math.PI*2);
                    ctx.fillStyle = `rgba(255, 215, 0, ${f.a})`; ctx.fill();
                    f.a += f.da; if(f.a<=0 || f.a>=1) f.da *= -1;
                    f.x += (Math.random()-0.5); f.y += (Math.random()-0.5);
                });
            }
            requestAnimationFrame(loop);
        } loop();
    }
    
    function startConfetti() {
        const ctx = setupCanvas(document.getElementById('confetti-canvas'));
        const confs = Array(120).fill().map(()=>({x:window.innerWidth/2, y:window.innerHeight/2, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15-5, c:`hsl(${Math.random()*360},100%,50%)`}));
        function loop() {
            ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
            confs.forEach(p=>{
                ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,6,6);
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.3;
            });
            requestAnimationFrame(loop);
        } loop();
    }

    window.addEventListener('resize', () => { 
        UI.bgCanvas.width = window.innerWidth; UI.bgCanvas.height = window.innerHeight;
        UI.fwCanvas.width = window.innerWidth; UI.fwCanvas.height = window.innerHeight;
        UI.ffCanvas.width = window.innerWidth; UI.ffCanvas.height = window.innerHeight;
    });
    
    initFireworks(); initFireflies();

</script>
</body>
</html>
